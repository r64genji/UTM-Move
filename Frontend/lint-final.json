[{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\App.jsx","messages":[{"ruleId":"no-dupe-else-if","severity":2,"message":"This branch can never execute. Its condition is a duplicate or covered by previous conditions in the if-else-if chain.","line":474,"column":28,"nodeType":"LogicalExpression","messageId":"unexpected","endLine":474,"endColumn":88}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport './index.css';\r\nimport { fetchStaticData, fetchDirections, fetchRouteFromBackend } from './services/api';\r\nimport { extractDirectedRouteSegment } from './utils/routeGeometryUtils';\r\nimport { getRouteColor } from './constants';\r\nimport MapComponent from './components/Map';\r\nimport RouteSelector from './components/RouteSelector';\r\nimport ServiceSelector from './components/ServiceSelector';\r\nimport ScheduleView from './components/ScheduleView';\r\nimport DirectionSelector from './components/DirectionSelector';\r\nimport SearchBar from './components/SearchBar';\r\nimport DirectionsPanel from './components/DirectionsPanel';\r\nimport MobileApp from './components/mobile/MobileApp';\r\nimport DevPanel from './components/DevPanel';\r\nimport AdminDashboard from './components/AdminDashboard';\r\n\r\n// Helper to safely get route from data\r\nconst findRoute = (data, name) => {\r\n    if (!data || !data.routes) return null;\r\n    return data.routes.find(r => r.name === name);\r\n};\r\n\r\n// AppInner contains all hooks and the real app UI.\r\n// App is just a thin shell that short-circuits to AdminDashboard when needed.\r\n// This split is required by the Rules of Hooks: hooks must never be called\r\n// conditionally (i.e. after an early return).\r\nfunction AppInner() {\r\n\r\n    const [data, setData] = useState({ stops: [], routes: [], locations: [], route_geometries: {} });\r\n    const [selectedRouteName, setSelectedRouteName] = useState(null);\r\n    const [selectedHeadsign, setSelectedHeadsign] = useState(null);\r\n    const [routeGeometry, setRouteGeometry] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    const [selectedServiceIndex, setSelectedServiceIndex] = useState(0);\r\n    const [showAllStops, setShowAllStops] = useState(false);\r\n\r\n    // Directions mode state\r\n    const [mode, setMode] = useState('explore'); // 'explore' | 'directions'\r\n    const [userLocation, setUserLocation] = useState(null);\r\n    const [customOrigin, setCustomOrigin] = useState(null);\r\n    const [directions, setDirections] = useState(null);\r\n    const [directionsLoading, setDirectionsLoading] = useState(false);\r\n    const [walkingGeometries, setWalkingGeometries] = useState([]);\r\n    const [busRouteGeometry, setBusRouteGeometry] = useState(null); // Legacy (single color)\r\n    const [busRouteSegments, setBusRouteSegments] = useState([]);   // New (multi color)\r\n    const [directionsMarkers, setDirectionsMarkers] = useState(null);\r\n    const [selectedDestination, setSelectedDestination] = useState(null);\r\n\r\n    // Mobile viewport detection\r\n    const [isMobile, setIsMobile] = useState(false);\r\n\r\n    // Developer settings for time/day override\r\n    const [devSettings, setDevSettings] = useState({\r\n        enabled: false,\r\n        time: new Date().toTimeString().slice(0, 5),\r\n        day: ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][new Date().getDay()]\r\n    });\r\n\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            setIsMobile(window.innerWidth < 768);\r\n        };\r\n        handleResize();\r\n        window.addEventListener('resize', handleResize);\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        const loadData = async () => {\r\n            // Cache Strategy: Stale-While-Revalidate or Cache-First\r\n            const CACHE_KEY = 'utm_static_data';\r\n            const CACHE_TS_KEY = 'utm_static_data_ts';\r\n            const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours\r\n\r\n            try {\r\n                // 1. Try to load from cache first\r\n                const cachedData = localStorage.getItem(CACHE_KEY);\r\n                const cachedTimestamp = localStorage.getItem(CACHE_TS_KEY);\r\n\r\n                if (cachedData && cachedTimestamp) {\r\n                    const age = Date.now() - parseInt(cachedTimestamp, 10);\r\n                    if (age < CACHE_DURATION) {\r\n                        try {\r\n                            const parsed = JSON.parse(cachedData);\r\n                            // Verify structure minimal validity\r\n                            if (parsed && (parsed.stops || parsed.routes)) {\r\n                                setData({\r\n                                    stops: parsed.stops || [],\r\n                                    routes: parsed.routes || [],\r\n                                    locations: parsed.locations || [],\r\n                                    route_geometries: parsed.route_geometries || {}\r\n                                });\r\n                                setLoading(false);\r\n                                console.log('Loaded static data from cache');\r\n                                return; // Skip network request if cache is valid\r\n                            }\r\n                        } catch {\r\n                            console.warn('Invalid cache, clearing...');\r\n                            localStorage.removeItem(CACHE_KEY);\r\n                            localStorage.removeItem(CACHE_TS_KEY);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // 2. Fetch from network if cache miss or expired\r\n                const result = await fetchStaticData();\r\n\r\n                const structuredData = {\r\n                    stops: result?.stops || [],\r\n                    routes: result?.routes || [],\r\n                    locations: result?.locations || [],\r\n                    route_geometries: result?.route_geometries || {}\r\n                };\r\n\r\n                setData(structuredData);\r\n\r\n                // Update cache\r\n                try {\r\n                    localStorage.setItem(CACHE_KEY, JSON.stringify(structuredData));\r\n                    localStorage.setItem(CACHE_TS_KEY, Date.now().toString());\r\n                } catch (e) {\r\n                    console.warn('Failed to save to localStorage (quota exceeded?)', e);\r\n                }\r\n\r\n            } catch (err) {\r\n                console.error(\"Failed to load static data\", err);\r\n\r\n                // Fallback: If network failed, try to use expired cache if available\r\n                const cachedData = localStorage.getItem(CACHE_KEY);\r\n                if (cachedData) {\r\n                    try {\r\n                        const parsed = JSON.parse(cachedData);\r\n                        setData({\r\n                            stops: parsed.stops || [],\r\n                            routes: parsed.routes || [],\r\n                            locations: parsed.locations || [],\r\n                            route_geometries: parsed.route_geometries || {}\r\n                        });\r\n                        console.warn('Network failed, using expired cache');\r\n                    } catch {\r\n                        setData({ stops: [], routes: [], locations: [] });\r\n                    }\r\n                } else {\r\n                    setData({ stops: [], routes: [], locations: [] });\r\n                }\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n        loadData();\r\n    }, []);\r\n\r\n    // Get user's GPS location\r\n    useEffect(() => {\r\n        if (!('geolocation' in navigator)) {\r\n            console.warn('Geolocation is not supported by this browser');\r\n            return;\r\n        }\r\n\r\n        // Request permission and watch position for continuous updates\r\n        const watchId = navigator.geolocation.watchPosition(\r\n            (position) => {\r\n                setUserLocation({\r\n                    lat: position.coords.latitude,\r\n                    lon: position.coords.longitude\r\n                });\r\n            },\r\n            (error) => {\r\n                // Detailed error handling for debugging\r\n                switch (error.code) {\r\n                    case error.PERMISSION_DENIED:\r\n                        console.warn('Location permission denied. Please enable location access in your browser settings.');\r\n                        break;\r\n                    case error.POSITION_UNAVAILABLE:\r\n                        console.warn('Location unavailable. Make sure GPS is enabled.');\r\n                        break;\r\n                    case error.TIMEOUT:\r\n                        console.warn('Location request timed out. Trying again...');\r\n                        break;\r\n                    default:\r\n                        console.warn('Could not get location:', error.message);\r\n                }\r\n            },\r\n            {\r\n                enableHighAccuracy: true,  // Use GPS on mobile\r\n                timeout: 10000,            // Wait up to 10 seconds\r\n                maximumAge: 60000          // Accept cached position up to 1 minute old\r\n            }\r\n        );\r\n\r\n        // Clean up watch on unmount\r\n        return () => navigator.geolocation.clearWatch(watchId);\r\n    }, []);\r\n\r\n    // When route changes, pick default headsign\r\n    const handleRouteSelect = async (routeName, serviceId = 'WEEKDAY', showLoop = false) => {\r\n        // Clear geometry if no route selected\r\n        if (!routeName) {\r\n            setSelectedRouteName(null);\r\n            setRouteGeometry(null);\r\n            return;\r\n        }\r\n\r\n        setSelectedRouteName(routeName);\r\n        const route = data.routes.find(r => r.name === routeName);\r\n        if (!route) return;\r\n\r\n        let serviceIndex = 0;\r\n        if (serviceId) {\r\n            const idx = route.services.findIndex(s => s.service_id === serviceId);\r\n            if (idx !== -1) serviceIndex = idx;\r\n        }\r\n\r\n        setSelectedServiceIndex(serviceIndex);\r\n\r\n        if (showLoop) {\r\n            // Show full loop: fetch geometries for ALL unique headsigns\r\n            // Clear specific headsign selection\r\n            setSelectedHeadsign(null);\r\n\r\n            const service = route.services[serviceIndex];\r\n            if (!service) return;\r\n\r\n            const headsigns = [...new Set(service.trips.map(t => t.headsign))];\r\n            const geometryPromises = headsigns.map(async (headsign) => {\r\n                const specificKey = `${routeName} : ${headsign}`;\r\n\r\n                // Bus routes should ONLY use pre-cached geometries from route_geometries.json\r\n                if (data.route_geometries && data.route_geometries[specificKey]) {\r\n                    return data.route_geometries[specificKey];\r\n                }\r\n\r\n                // No API fallback for bus routes - log warning if not found\r\n                console.warn(`Route geometry not found in cache for: \"${specificKey}\". Please pre-cache this route.`);\r\n                return null;\r\n            });\r\n\r\n            const geometries = await Promise.all(geometryPromises);\r\n            const validGeometries = geometries.filter(Boolean);\r\n\r\n            // Combine into MultiLineString\r\n            const multiLineGeometry = {\r\n                type: 'MultiLineString',\r\n                coordinates: validGeometries.map(g => g.coordinates)\r\n            };\r\n\r\n            setRouteGeometry(multiLineGeometry);\r\n\r\n        } else {\r\n            // Default behavior: Select first headsign\r\n            updateHeadsignsForService(route, serviceIndex);\r\n        }\r\n    };\r\n\r\n    const updateHeadsignsForService = (route, serviceIdx) => {\r\n        const service = route.services[serviceIdx];\r\n        if (!service) {\r\n            handleDirectionSelect(route.name, null);\r\n            return;\r\n        }\r\n\r\n        const headsigns = new Set();\r\n        service.trips.forEach(trip => headsigns.add(trip.headsign));\r\n        const headsignArray = Array.from(headsigns);\r\n        const defaultHeadsign = headsignArray.length > 0 ? headsignArray[0] : null;\r\n        handleDirectionSelect(route.name, defaultHeadsign);\r\n    };\r\n\r\n    const handleServiceSelect = (index) => {\r\n        setSelectedServiceIndex(index);\r\n        const route = data.routes.find(r => r.name === selectedRouteName);\r\n        if (route) {\r\n            updateHeadsignsForService(route, index);\r\n        }\r\n    };\r\n\r\n    const handleDirectionSelect = async (routeName, headsign) => {\r\n        setSelectedHeadsign(headsign);\r\n        setRouteGeometry(null);\r\n\r\n        const route = data.routes.find(r => r.name === routeName);\r\n        if (!route) return;\r\n\r\n        const specificKey = `${routeName} : ${headsign}`;\r\n\r\n        // Bus routes should ONLY use pre-cached geometries from route_geometries.json\r\n        // No API fallback - all bus routes should be pre-computed\r\n        if (data.route_geometries && data.route_geometries[specificKey]) {\r\n            setRouteGeometry(data.route_geometries[specificKey]);\r\n            return;\r\n        }\r\n\r\n        // If not found in cache, log a warning (should not happen if all routes are cached)\r\n        console.warn(`Route geometry not found in cache for: \"${specificKey}\". Please pre-cache this route.`);\r\n    };\r\n\r\n    const handleGetDirections = async (destination, options = {}) => {\r\n        setMode('directions');\r\n        setSelectedDestination(destination);\r\n        setDirectionsLoading(true);\r\n        setDirections(null);\r\n        setWalkingGeometries([]);\r\n        setBusRouteGeometry(null);\r\n        setBusRouteSegments([]);\r\n        setDirectionsMarkers(null);\r\n\r\n        try {\r\n            // Use overrideOrigin if provided (fixes stale closure issue when changing origin)\r\n            const origin = options.overrideOrigin || customOrigin || userLocation;\r\n            if (!origin) {\r\n                setDirections({ error: 'Location not available', suggestion: 'Please enable GPS or select a starting point.' });\r\n                return;\r\n            }\r\n\r\n            const currentTime = options.time || new Date().toTimeString().slice(0, 5);\r\n            const currentDay = options.day || null;\r\n\r\n            // Apply dev settings override if enabled\r\n            const params = {\r\n                originLat: origin.lat,\r\n                originLon: origin.lon,\r\n                destLocationId: destination.id,\r\n                time: devSettings.enabled ? devSettings.time : currentTime,\r\n                day: devSettings.enabled ? devSettings.day : currentDay,\r\n                forceBus: options.forceBus\r\n            };\r\n\r\n            // For pinned locations, pass coordinates directly\r\n            if (destination.category === 'pinned' || destination.id?.startsWith('PINNED_')) {\r\n                params.destLat = destination.lat;\r\n                params.destLon = destination.lon;\r\n                params.destName = destination.name;\r\n            }\r\n\r\n            const result = await fetchDirections(params);\r\n            setDirections(result);\r\n\r\n            if (result && !result.error) {\r\n                const walkGeoms = [];\r\n\r\n                if (result.steps) {\r\n                    for (const step of result.steps) {\r\n                        if (step.type === 'walk' && step.from && step.to) {\r\n                            const walkRouteData = await fetchRouteFromBackend([\r\n                                [step.from.lon, step.from.lat],\r\n                                [step.to.lon, step.to.lat]\r\n                            ], 'foot-walking');\r\n\r\n                            if (walkRouteData && walkRouteData.geometry) {\r\n                                walkGeoms.push(walkRouteData.geometry);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (result.type === 'WALK_ONLY' && result.walkingRoute) {\r\n                    const walkRouteData = await fetchRouteFromBackend([\r\n                        [result.walkingRoute.from.lon, result.walkingRoute.from.lat],\r\n                        [result.walkingRoute.to.lon, result.walkingRoute.to.lat]\r\n                    ], 'foot-walking');\r\n\r\n                    if (walkRouteData && walkRouteData.geometry) {\r\n                        walkGeoms.push(walkRouteData.geometry);\r\n                    }\r\n                }\r\n\r\n                setWalkingGeometries(walkGeoms);\r\n\r\n                // Handle bus route colors (only if there's a bus route)\r\n                const routeStr = result.summary?.route || '';\r\n                const routeParts = routeStr.split(/→|->/).map(s => s.trim()).filter(Boolean);\r\n                const color1 = getRouteColor(routeParts[0]);\r\n                const color2 = routeParts.length > 1 ? getRouteColor(routeParts[1]) : color1;\r\n\r\n                const newSegments = [];\r\n\r\n                if (result.routeGeometry && result.originStop && result.destStop) {\r\n                    const segment = extractDirectedRouteSegment(\r\n                        result.routeGeometry,\r\n                        { lat: result.originStop.lat, lon: result.originStop.lon },\r\n                        { lat: result.destStop.lat, lon: result.destStop.lon }\r\n                    );\r\n                    if (segment) {\r\n                        setBusRouteGeometry(segment); // Keep legacy for fallback\r\n                        newSegments.push({\r\n                            coordinates: segment.coordinates,\r\n                            color: color1,\r\n                            type: 'bus'\r\n                        });\r\n                    } else {\r\n                        setBusRouteGeometry(result.routeGeometry);\r\n                        newSegments.push({ coordinates: result.routeGeometry.coordinates, color: color1, type: 'bus' });\r\n                    }\r\n                } else if (result.isLoopRoute && result.routeGeometries && result.loopInfo) {\r\n                    const transferStop = data.stops.find(s => s.id === result.loopInfo.transferPoint);\r\n\r\n                    if (result.routeGeometries.firstLeg && result.originStop && transferStop) {\r\n                        const seg1 = extractDirectedRouteSegment(\r\n                            result.routeGeometries.firstLeg,\r\n                            { lat: result.originStop.lat, lon: result.originStop.lon },\r\n                            { lat: transferStop.lat, lon: transferStop.lon }\r\n                        );\r\n                        if (seg1?.coordinates) {\r\n                            newSegments.push({ coordinates: seg1.coordinates, color: color1, type: 'bus' });\r\n                        }\r\n                    }\r\n\r\n                    if (result.routeGeometries.secondLeg && transferStop && result.destStop) {\r\n                        const seg2 = extractDirectedRouteSegment(\r\n                            result.routeGeometries.secondLeg,\r\n                            { lat: transferStop.lat, lon: transferStop.lon },\r\n                            { lat: result.destStop.lat, lon: result.destStop.lon }\r\n                        );\r\n                        if (seg2?.coordinates) {\r\n                            newSegments.push({ coordinates: seg2.coordinates, color: color2, type: 'bus' });\r\n                        }\r\n                    }\r\n\r\n                } else if (result.routeGeometries && Array.isArray(result.routeGeometries)) {\r\n                    // Generic N-Leg Support: Iterate through all legs\r\n                    result.routeGeometries.forEach((legGeom) => {\r\n                        const legColor = getRouteColor(legGeom.routeName);\r\n                        const { fromStop, toStop } = legGeom;\r\n\r\n                        // Handle merged legs (same route, continuous ride through headsign change)\r\n                        if (legGeom.isMergedLeg && legGeom.first && legGeom.second) {\r\n                            // Merged leg with two parts (e.g., Route F To KTR → Route F To P19A)\r\n                            const firstPart = legGeom.first;\r\n                            const secondPart = legGeom.second;\r\n\r\n                            if (firstPart?.coordinates?.length > 0) {\r\n                                const lastCoord = firstPart.coordinates[firstPart.coordinates.length - 1];\r\n                                const terminusPoint = { lat: lastCoord[1], lon: lastCoord[0] };\r\n                                const seg1 = extractDirectedRouteSegment(firstPart, fromStop, terminusPoint);\r\n                                if (seg1?.coordinates) newSegments.push({ coordinates: seg1.coordinates, color: legColor, type: 'bus' });\r\n                            }\r\n\r\n                            if (secondPart?.coordinates?.length > 0) {\r\n                                const firstCoord = secondPart.coordinates[0];\r\n                                const terminusPoint = { lat: firstCoord[1], lon: firstCoord[0] };\r\n                                const seg2 = extractDirectedRouteSegment(secondPart, terminusPoint, toStop);\r\n                                if (seg2?.coordinates) newSegments.push({ coordinates: seg2.coordinates, color: legColor, type: 'bus' });\r\n                            }\r\n                        } else if (legGeom.isLoop && legGeom.first && legGeom.second) {\r\n                            // Loop route with two parts\r\n                            const firstPart = legGeom.first;\r\n                            const secondPart = legGeom.second;\r\n\r\n                            if (firstPart?.coordinates?.length > 0) {\r\n                                const lastCoord = firstPart.coordinates[firstPart.coordinates.length - 1];\r\n                                const terminusPoint = { lat: lastCoord[1], lon: lastCoord[0] };\r\n                                const seg1 = extractDirectedRouteSegment(firstPart, fromStop, terminusPoint);\r\n                                if (seg1?.coordinates) newSegments.push({ coordinates: seg1.coordinates, color: legColor, type: 'bus' });\r\n                            }\r\n\r\n                            if (secondPart?.coordinates?.length > 0) {\r\n                                const firstCoord = secondPart.coordinates[0];\r\n                                const terminusPoint = { lat: firstCoord[1], lon: firstCoord[0] };\r\n                                const seg2 = extractDirectedRouteSegment(secondPart, terminusPoint, toStop);\r\n                                if (seg2?.coordinates) newSegments.push({ coordinates: seg2.coordinates, color: legColor, type: 'bus' });\r\n                            }\r\n                        } else if (legGeom.geometry && fromStop && toStop) {\r\n                            // Regular single-part route\r\n                            const seg = extractDirectedRouteSegment(legGeom.geometry, fromStop, toStop);\r\n                            if (seg?.coordinates) {\r\n                                newSegments.push({ coordinates: seg.coordinates, color: legColor, type: 'bus' });\r\n                            } else if (legGeom.geometry.coordinates) {\r\n                                // Fallback: just show the whole thing if extraction fails\r\n                                newSegments.push({ coordinates: legGeom.geometry.coordinates, color: legColor, type: 'bus' });\r\n                            }\r\n                        }\r\n                    });\r\n                } else if (result.routeGeometry && result.originStop && result.destStop) {\r\n                    // Legacy Fallback for single leg\r\n                    const color = getRouteColor(routeParts[0]);\r\n                    const segment = extractDirectedRouteSegment(\r\n                        result.routeGeometry,\r\n                        { lat: result.originStop.lat, lon: result.originStop.lon },\r\n                        { lat: result.destStop.lat, lon: result.destStop.lon }\r\n                    );\r\n                    newSegments.push({\r\n                        coordinates: segment ? segment.coordinates : result.routeGeometry.coordinates,\r\n                        color: color,\r\n                        type: 'bus'\r\n                    });\r\n                }\r\n                setBusRouteSegments(newSegments);\r\n\r\n                setDirectionsMarkers({\r\n                    destination: result.destination,\r\n                    originStop: result.originStop,\r\n                    destStop: result.destStop\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error('Error getting directions:', error);\r\n            setDirections({ error: 'Failed to get directions' });\r\n        } finally {\r\n            setDirectionsLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleSelectOrigin = (location) => {\r\n        if (!location) {\r\n            setCustomOrigin(null);\r\n            // Recalculate with GPS location if destination exists\r\n            if (selectedDestination && userLocation) {\r\n                handleGetDirections(selectedDestination, { overrideOrigin: userLocation });\r\n            }\r\n            return;\r\n        }\r\n        const newOrigin = {\r\n            lat: location.lat,\r\n            lon: location.lon,\r\n            name: location.name\r\n        };\r\n        setCustomOrigin(newOrigin);\r\n\r\n        // Recalculate directions with new origin if destination exists\r\n        // Pass newOrigin directly to avoid stale closure issue\r\n        if (selectedDestination) {\r\n            handleGetDirections(selectedDestination, { overrideOrigin: newOrigin });\r\n        }\r\n    };\r\n\r\n    const handleUseCurrentLocation = () => {\r\n        setCustomOrigin(null);\r\n    };\r\n\r\n    const handleCloseDirections = () => {\r\n        setMode('explore');\r\n        setDirections(null);\r\n        setWalkingGeometries([]);\r\n        setBusRouteGeometry(null);\r\n        setBusRouteSegments([]);\r\n        setDirectionsMarkers(null);\r\n    };\r\n\r\n    const handlePlanFutureTrip = (day, time, isForceBus = false) => {\r\n        if (selectedDestination) {\r\n            handleGetDirections(selectedDestination, { day, time, forceBus: isForceBus });\r\n        }\r\n    };\r\n\r\n    // Restore saved journey when returning to navigate tab\r\n    const handleRestoreJourney = (savedJourney) => {\r\n        if (!savedJourney) return;\r\n\r\n        setMode('directions');\r\n\r\n        if (savedJourney.origin) {\r\n            setCustomOrigin(savedJourney.origin);\r\n        }\r\n        if (savedJourney.destination) {\r\n            setSelectedDestination(savedJourney.destination);\r\n        }\r\n        if (savedJourney.directions) {\r\n            setDirections(savedJourney.directions);\r\n        }\r\n        if (savedJourney.walkingGeometries) {\r\n            setWalkingGeometries(savedJourney.walkingGeometries);\r\n        }\r\n        if (savedJourney.busRouteGeometry) {\r\n            setBusRouteGeometry(savedJourney.busRouteGeometry);\r\n        }\r\n        if (savedJourney.busRouteSegments) {\r\n            setBusRouteSegments(savedJourney.busRouteSegments);\r\n        }\r\n        if (savedJourney.directionsMarkers) {\r\n            setDirectionsMarkers(savedJourney.directionsMarkers);\r\n        }\r\n    };\r\n\r\n    const selectedRouteData = findRoute(data, selectedRouteName);\r\n    let selectedStopIds = [];\r\n    let activeService = null;\r\n    let availableHeadsigns = [];\r\n\r\n    if (selectedRouteData && selectedRouteData.services) {\r\n        activeService = selectedRouteData.services[selectedServiceIndex];\r\n        if (activeService && activeService.trips) {\r\n            availableHeadsigns = [...new Set(activeService.trips.map(t => t.headsign))];\r\n\r\n            if (selectedHeadsign) {\r\n                const trip = activeService.trips.find(t => t.headsign === selectedHeadsign);\r\n                if (trip) {\r\n                    selectedStopIds = trip.stops_sequence;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    let visibleStops = [];\r\n    if (mode === 'explore') {\r\n        if (showAllStops) {\r\n            visibleStops = data?.stops || [];\r\n        } else if (selectedStopIds.length > 0) {\r\n            visibleStops = (data?.stops || []).filter(s => selectedStopIds.includes(s.id));\r\n        }\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"loading-container\" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100vh', background: 'var(--bg-dark)', color: 'white' }}>\r\n                <div className=\"loading-spinner\" style={{ width: '40px', height: '40px', border: '4px solid rgba(255,255,255,0.1)', borderTopColor: 'var(--color-primary)', borderRadius: '50%', animation: 'spin 1s linear infinite' }}></div>\r\n                <p style={{ marginTop: '16px', fontWeight: '500' }}>Loading UTM Move...</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Render mobile app for small screens\r\n    if (isMobile) {\r\n        return (\r\n            <>\r\n                <MobileApp\r\n                    data={data}\r\n                    userLocation={customOrigin || userLocation}\r\n                    selectedOrigin={customOrigin}\r\n                    selectedDestination={selectedDestination}\r\n                    onGetDirections={handleGetDirections}\r\n                    onSelectOrigin={handleSelectOrigin}\r\n                    onSelectRoute={handleRouteSelect}\r\n                    onDirectionSelect={handleDirectionSelect}\r\n                    mode={mode}\r\n                    visibleStops={visibleStops}\r\n                    selectedStopIds={selectedStopIds}\r\n                    routeGeometry={routeGeometry}\r\n                    selectedServiceIndex={selectedServiceIndex}\r\n                    walkingGeometries={walkingGeometries}\r\n                    busRouteGeometry={busRouteGeometry}\r\n                    busRouteSegments={busRouteSegments}\r\n                    directionsMarkers={directionsMarkers}\r\n                    directions={directions}\r\n                    directionsLoading={directionsLoading}\r\n                    onCloseDirections={handleCloseDirections}\r\n                    onPlanFutureTrip={handlePlanFutureTrip}\r\n                    onRestoreJourney={handleRestoreJourney}\r\n                />\r\n                <DevPanel devSettings={devSettings} onSettingsChange={setDevSettings} />\r\n            </>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"app-container\">\r\n            {/* Sidebar */}\r\n            <aside className=\"app-sidebar\">\r\n                <div className=\"sidebar-header\">\r\n                    <h1 className=\"brand\">\r\n                        <span className=\"material-icons-round\" style={{ color: 'var(--color-primary)', fontSize: '24px' }}>directions_bus</span>\r\n                        UTM Move\r\n                    </h1>\r\n                </div>\r\n\r\n                <div className=\"sidebar-content\">\r\n                    {/* Mode Switcher */}\r\n                    <div className=\"mode-switcher\">\r\n                        <button\r\n                            className={`mode-btn ${mode === 'explore' ? 'active' : ''}`}\r\n                            onClick={() => setMode('explore')}\r\n                        >\r\n                            <span className=\"material-icons-round\">map</span>\r\n                            Routes\r\n                        </button>\r\n                        <button\r\n                            className={`mode-btn ${mode === 'directions' ? 'active' : ''}`}\r\n                            onClick={() => setMode('directions')}\r\n                        >\r\n                            <span className=\"material-icons-round\">near_me</span>\r\n                            Directions\r\n                        </button>\r\n                    </div>\r\n\r\n                    <button\r\n                        className=\"mode-btn\"\r\n                        style={{ width: '100%', justifyContent: 'space-between', background: 'var(--surface-dark)', border: '1px solid var(--border-color)' }}\r\n                        onClick={() => setShowAllStops(!showAllStops)}\r\n                    >\r\n                        <span style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>\r\n                            <span className=\"material-icons-round\" style={{ color: showAllStops ? 'var(--color-primary)' : 'var(--text-muted)' }}>visibility</span>\r\n                            {showAllStops ? \"Hide All Stops\" : \"Show All Stops\"}\r\n                        </span>\r\n                        <span className=\"material-icons-round\" style={{ fontSize: '16px' }}>chevron_right</span>\r\n                    </button>\r\n\r\n                    {mode === 'explore' ? (\r\n                        <>\r\n                            <div className=\"section-title\">\r\n                                <span>Select a Route</span>\r\n                                <span style={{ background: 'rgba(255,255,255,0.1)', padding: '2px 8px', borderRadius: '12px', fontSize: '10px' }}>\r\n                                    {(data?.routes || []).length} Active\r\n                                </span>\r\n                            </div>\r\n\r\n                            <div className=\"route-grid\">\r\n                                {(data?.routes || []).map(route => (\r\n                                    <div\r\n                                        key={route.name}\r\n                                        className={`route-card ${selectedRouteName === route.name ? 'active' : ''}`}\r\n                                        onClick={() => handleRouteSelect(route.name)}\r\n                                    >\r\n                                        <div className=\"route-card-header\">\r\n                                            <span className=\"route-name\">{route.name}</span>\r\n                                            <div className=\"status-dot\" style={{ backgroundColor: getRouteColor(route.name), boxShadow: `0 0 8px ${getRouteColor(route.name)}` }}></div>\r\n                                        </div>\r\n                                        <span className=\"route-desc\">\r\n                                            {route.services[0]?.trips[0]?.headsign || \"View Schedule\"}\r\n                                        </span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n\r\n                            {selectedRouteName && (\r\n                                <div style={{ marginTop: '1rem' }}>\r\n                                    <ServiceSelector\r\n                                        services={selectedRouteData?.services}\r\n                                        activeIndex={selectedServiceIndex}\r\n                                        onSelectService={handleServiceSelect}\r\n                                    />\r\n                                    <div style={{ marginTop: '0.5rem' }}></div>\r\n                                    <DirectionSelector\r\n                                        headsigns={availableHeadsigns}\r\n                                        selectedHeadsign={selectedHeadsign}\r\n                                        onSelectHeadsign={(h) => handleDirectionSelect(selectedRouteName, h)}\r\n                                    />\r\n                                    <ScheduleView service={activeService} stops={data?.stops || []} currentHeadsign={selectedHeadsign} />\r\n                                </div>\r\n                            )}\r\n\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <SearchBar\r\n                                locations={data.locations || []}\r\n                                stops={data.stops || []}\r\n                                onSelectDestination={handleGetDirections}\r\n                                onSelectOrigin={handleSelectOrigin}\r\n                                onUseCurrentLocation={handleUseCurrentLocation}\r\n                                disabled={directionsLoading}\r\n                            />\r\n                            <DirectionsPanel\r\n                                directions={directions}\r\n                                onClose={handleCloseDirections}\r\n                                loading={directionsLoading}\r\n                                onPlanFutureTrip={handlePlanFutureTrip}\r\n                            />\r\n                        </>\r\n                    )}\r\n\r\n                </div>\r\n\r\n                <div className=\"sidebar-footer\">\r\n                    <span>© UTM 2026</span>\r\n                    <div style={{ display: 'flex', gap: '12px' }}>\r\n                        <span>Help</span>\r\n                        <span>Feedback</span>\r\n                    </div>\r\n                </div>\r\n            </aside>\r\n\r\n            {/* Map Area */}\r\n            <main className=\"map-area\">\r\n                {/* Floating Controls */}\r\n                <div className=\"floating-tools\">\r\n                    <button\r\n                        className=\"tool-btn\"\r\n                        title=\"Zoom in\"\r\n                        onClick={() => window.dispatchEvent(new CustomEvent('map-zoom', { detail: { direction: 'in' } }))}\r\n                    >\r\n                        <span className=\"material-icons-round\">add</span>\r\n                    </button>\r\n                    <button\r\n                        className=\"tool-btn\"\r\n                        title=\"Zoom out\"\r\n                        onClick={() => window.dispatchEvent(new CustomEvent('map-zoom', { detail: { direction: 'out' } }))}\r\n                    >\r\n                        <span className=\"material-icons-round\">remove</span>\r\n                    </button>\r\n                    <button\r\n                        className=\"tool-btn\"\r\n                        title=\"Centre on my location\"\r\n                        onClick={() => window.dispatchEvent(new Event('map-center-user'))}\r\n                    >\r\n                        <span className=\"material-icons-round\">my_location</span>\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Map */}\r\n                <div style={{ height: '100%', width: '100%' }}>\r\n                    <MapComponent\r\n                        stops={visibleStops}\r\n                        selectedRouteStops={selectedStopIds}\r\n                        routeGeometry={mode === 'explore' ? routeGeometry : null}\r\n                        routeColor={getRouteColor(selectedRouteName)}\r\n                        walkingGeometries={mode === 'directions' ? walkingGeometries : []}\r\n                        busRouteGeometry={mode === 'directions' ? busRouteGeometry : null}\r\n                        busRouteSegments={mode === 'directions' ? busRouteSegments : []}\r\n                        userLocation={mode === 'directions' ? (customOrigin || userLocation) : null}\r\n                        directionsMarkers={mode === 'directions' ? directionsMarkers : null}\r\n                    />\r\n                </div>\r\n\r\n                {/* Legend */}\r\n                <div className=\"legend-card\">\r\n                    <div className=\"legend-item\">\r\n                        <div className=\"dot\" style={{ background: '#22c55e' }}></div>\r\n                        <span>Active</span>\r\n                    </div>\r\n                    <div className=\"legend-item\">\r\n                        <div className=\"dot\" style={{ background: '#eab308' }}></div>\r\n                        <span>Delayed</span>\r\n                    </div>\r\n                    <div className=\"legend-item\">\r\n                        <div className=\"dot\" style={{ background: '#9ca3af' }}></div>\r\n                        <span>Inactive</span>\r\n                    </div>\r\n                </div>\r\n            </main>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction App() {\r\n    if (new URLSearchParams(window.location.search).has('admin')) {\r\n        return <AdminDashboard />;\r\n    }\r\n    return <AppInner />;\r\n}\r\n\r\nexport default App;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\AdminDashboard.jsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  15 |     useEffect(() => {\n  16 |         // eslint-disable-next-line react-hooks/set-state-in-effect -- loadReports is async; setState fires after the Promise resolves, not synchronously.\n> 17 |         loadReports();\n     |         ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |     }, [loadReports]);\n  19 |\n  20 |     const getTypeColor = (type) => {","line":17,"column":9,"nodeType":null,"endLine":17,"endColumn":20,"suppressions":[{"kind":"directive","justification":"loadReports is async; setState fires after the Promise resolves, not synchronously."}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\DevPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\DirectionSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\DirectionsPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\Map.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'_selectedRouteStops' is defined but never used.","line":149,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"_selectedRouteStops"},"fix":{"range":[5576,5679],"text":""},"desc":"Remove unused variable '_selectedRouteStops'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect } from 'react';\r\nimport { MapContainer, TileLayer, Marker, Popup, Polyline, CircleMarker, useMap, useMapEvents } from 'react-leaflet';\r\nimport L from 'leaflet';\r\nimport 'leaflet/dist/leaflet.css';\r\nimport { getRouteColor } from '../constants';\r\n\r\n// Fix for default marker icon in React-Leaflet\r\nimport icon from 'leaflet/dist/images/marker-icon.png';\r\nimport iconShadow from 'leaflet/dist/images/marker-shadow.png';\r\n\r\nlet DefaultIcon = L.icon({\r\n    iconUrl: icon,\r\n    shadowUrl: iconShadow,\r\n    iconSize: [25, 41],\r\n    iconAnchor: [12, 41]\r\n});\r\n\r\nL.Marker.prototype.options.icon = DefaultIcon;\r\n\r\n// Custom icons for directions\r\nconst userIcon = L.divIcon({\r\n    className: 'user-marker',\r\n    html: '<div style=\"background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);\"></div>',\r\n    iconSize: [22, 22],\r\n    iconAnchor: [11, 11]\r\n});\r\n\r\nconst destinationIcon = L.divIcon({\r\n    className: 'destination-marker',\r\n    html: '<div style=\"background: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;\">📍</div>',\r\n    iconSize: [26, 26],\r\n    iconAnchor: [13, 13]\r\n});\r\n\r\n// Custom icon for pinned origin location\r\nconst pinnedOriginIcon = L.divIcon({\r\n    className: 'pinned-origin-marker',\r\n    html: '<div style=\"background: #3b82f6; width: 24px; height: 24px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;\"><div style=\"width: 8px; height: 8px; background: white; border-radius: 50%;\"></div></div>',\r\n    iconSize: [32, 32],\r\n    iconAnchor: [16, 16]\r\n});\r\n\r\n// Custom icon for pinned destination location\r\nconst pinnedDestinationIcon = L.divIcon({\r\n    className: 'pinned-destination-marker',\r\n    html: '<div style=\"background: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;\"><div style=\"width: 8px; height: 8px; background: white; border-radius: 50%;\"></div></div>',\r\n    iconSize: [32, 32],\r\n    iconAnchor: [16, 16]\r\n});\r\n\r\n// Custom icon for bus stops\r\nconst busStopIcon = L.divIcon({\r\n    className: 'bus-stop-marker',\r\n    html: '<div style=\"background: #3b82f6; width: 26px; height: 26px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white;\"><span class=\"material-symbols-outlined\" style=\"font-size: 16px;\">directions_bus</span></div>',\r\n    iconSize: [26, 26],\r\n    iconAnchor: [13, 13]\r\n});\r\n\r\nimport 'leaflet-arrowheads';\r\n\r\n// Helper component to handle map click events for pinning locations\r\nfunction MapClickHandler({ pinMode, onMapClick }) {\r\n    useMapEvents({\r\n        click: (e) => {\r\n            if (pinMode && onMapClick) {\r\n                onMapClick(e.latlng.lat, e.latlng.lng, pinMode);\r\n            }\r\n        }\r\n    });\r\n    return null;\r\n}\r\n\r\n// Helper to update map view bounds - prevents \"fighting\" the user's drag/zoom\r\nfunction MapUpdater({ bounds }) {\r\n    const map = useMap();\r\n    const lastBoundsStr = React.useRef(\"\");\r\n\r\n    useEffect(() => {\r\n        if (!bounds) return;\r\n\r\n        const boundsStr = bounds.toBBoxString();\r\n        // Only fit bounds if they have actually changed (e.g. new route selected)\r\n        // This prevents snapping the map back while the user is actively dragging/zooming\r\n        if (boundsStr !== lastBoundsStr.current) {\r\n            lastBoundsStr.current = boundsStr;\r\n            map.fitBounds(bounds, {\r\n                padding: [50, 50],\r\n                maxZoom: 16,\r\n                animate: true,\r\n                duration: 0.5\r\n            });\r\n        }\r\n    }, [bounds, map]);\r\n    return null;\r\n}\r\n\r\n// Helper to handle external zoom/center control events\r\nfunction MapControlHandler({ userLocation }) {\r\n    const map = useMap();\r\n\r\n    useEffect(() => {\r\n        const handleZoom = (e) => {\r\n            if (e.detail.direction === 'in') {\r\n                map.zoomIn();\r\n            } else if (e.detail.direction === 'out') {\r\n                map.zoomOut();\r\n            }\r\n        };\r\n\r\n        const handleCenterUser = () => {\r\n            if (userLocation) {\r\n                map.flyTo([userLocation.lat, userLocation.lon || userLocation.lng], 17, {\r\n                    animate: true,\r\n                    duration: 0.5\r\n                });\r\n            }\r\n        };\r\n\r\n        window.addEventListener('map-zoom', handleZoom);\r\n        window.addEventListener('map-center-user', handleCenterUser);\r\n\r\n        return () => {\r\n            window.removeEventListener('map-zoom', handleZoom);\r\n            window.removeEventListener('map-center-user', handleCenterUser);\r\n        };\r\n    }, [map, userLocation]);\r\n\r\n    return null;\r\n}\r\n\r\n// Helper to handle window resize\r\nfunction MapResizeHandler() {\r\n    const map = useMap();\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            map.invalidateSize();\r\n        };\r\n        window.addEventListener('resize', handleResize);\r\n        // Initial invalidate to ensure correct size on mount\r\n        setTimeout(() => map.invalidateSize(), 100);\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, [map]);\r\n    return null;\r\n}\r\n\r\nconst MapComponent = ({\r\n    stops,\r\n    routes = [],                // All routes data for computing which routes serve each stop\r\n    _selectedRouteStops,\r\n    routeGeometry,\r\n    routeColor = '#3b82f6',     // Custom color for the explorer route\r\n    allRouteGeometries = [],    // Array of { geometry, color, name } for all routes display\r\n    // Directions-specific props\r\n    walkingGeometries = [],     // Array of walking route GeoJSON geometries\r\n    busRouteGeometry = null,    // Legacy: Single bus route geometry\r\n    busRouteSegments = [],      // New: Array of { coordinates, color, type }\r\n    userLocation = null,        // { lat, lon } for user GPS marker\r\n    directionsMarkers = null,   // { origin, destination, originStop, destStop }\r\n    // Pin location props\r\n    onMapClick = null,          // Callback: (lat, lon, type) => void\r\n    pinnedLocation = null,      // { lat, lon, type: 'origin' | 'destination' }\r\n    pinMode = null,             // 'origin' | 'destination' | null\r\n    onSelectRoute = null,        // Callback: (route) => void - for selecting route from stop popup\r\n    // Arrival info props (for route detail page)\r\n    showArrivalInfo = false,     // Whether to show next arrival time in popup\r\n    selectedRouteName = null,    // Currently selected route name for ETA\r\n    selectedHeadsign = null      // Currently selected headsign for ETA\r\n}) => {\r\n    // UTM Coordinates as default center\r\n    const defaultCenter = [1.559704, 103.634727];\r\n    const busPolylineRef = React.useRef(null);\r\n    const segmentRefs = React.useRef({});\r\n    const routePolylineRefs = React.useRef({});\r\n\r\n    // Helper: Get routes that serve a specific stop\r\n    const getRoutesForStop = React.useCallback((stopId) => {\r\n        if (!routes || routes.length === 0) return [];\r\n        const targetId = String(stopId);\r\n        return routes.filter(route =>\r\n            route.services?.some(service =>\r\n                service.trips?.some(trip =>\r\n                    trip.stops_sequence?.some(id => String(id) === targetId)\r\n                )\r\n            )\r\n        );\r\n    }, [routes]);\r\n\r\n    // Helper: Get next arrival time for a route at a specific stop\r\n    const getNextArrival = React.useCallback((stopId, routeName, headsign) => {\r\n        if (!routes || !routeName) return null;\r\n\r\n        const now = new Date();\r\n        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\r\n        const today = days[now.getDay()];\r\n        const currentMins = now.getHours() * 60 + now.getMinutes();\r\n\r\n        // For Route E, check all variants (E(JA), E(CP), E(N24))\r\n        const routesToCheck = routeName === 'Route E'\r\n            ? routes.filter(r => r.name.startsWith('Route E'))\r\n            : [routes.find(r => r.name === routeName)].filter(Boolean);\r\n\r\n        if (routesToCheck.length === 0) return null;\r\n\r\n        let earliestArrival = null;\r\n\r\n        for (const route of routesToCheck) {\r\n            // Find active service for today\r\n            const service = route.services?.find(s => s.days?.includes(today));\r\n            if (!service) continue;\r\n\r\n            // Find trips - if headsign specified, filter to that headsign\r\n            const tripsToCheck = headsign\r\n                ? service.trips?.filter(t => t.headsign === headsign)\r\n                : service.trips || [];\r\n\r\n            for (const trip of tripsToCheck) {\r\n                // Find stop index in the sequence\r\n                const stopIndex = trip.stops_sequence?.findIndex(id => String(id) === String(stopId));\r\n                if (stopIndex === -1 || stopIndex === undefined) continue;\r\n\r\n                // Calculate arrival offset for this stop\r\n                const arrivalOffset = trip.arrival_offsets?.[stopIndex] || (stopIndex * 3);\r\n\r\n                // Find next departure time\r\n                for (const departTime of trip.times || []) {\r\n                    const [h, m] = departTime.split(':').map(Number);\r\n                    const departMins = h * 60 + m;\r\n                    const arrivalMins = departMins + arrivalOffset;\r\n\r\n                    // Skip Friday prayer break (12:40 - 14:00)\r\n                    if (today === 'friday' && arrivalMins >= 760 && arrivalMins < 840) continue;\r\n\r\n                    if (arrivalMins >= currentMins) {\r\n                        if (!earliestArrival || arrivalMins < earliestArrival.arrivalMins) {\r\n                            const arrivalH = Math.floor(arrivalMins / 60) % 24;\r\n                            const arrivalM = arrivalMins % 60;\r\n                            earliestArrival = {\r\n                                time: `${String(arrivalH).padStart(2, '0')}:${String(arrivalM).padStart(2, '0')}`,\r\n                                minsUntil: arrivalMins - currentMins,\r\n                                arrivalMins\r\n                            };\r\n                        }\r\n                        break; // Found next for this trip, check other routes\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return earliestArrival;\r\n    }, [routes]);\r\n\r\n    // Convert GeoJSON LineString (lon, lat) to Leaflet (lat, lon)\r\n    const polylinePositions = React.useMemo(() => {\r\n        if (!routeGeometry) return [];\r\n        if (routeGeometry.type === 'LineString') {\r\n            return [routeGeometry.coordinates.map(coord => [coord[1], coord[0]])];\r\n        } else if (routeGeometry.type === 'MultiLineString') {\r\n            return routeGeometry.coordinates.map(line => line.map(coord => [coord[1], coord[0]]));\r\n        }\r\n        return [];\r\n    }, [routeGeometry]);\r\n\r\n    // Legacy support — memoized to avoid destabilizing the bounds useMemo on every render\r\n    const busRoutePositions = React.useMemo(() =>\r\n        busRouteGeometry\r\n            ? busRouteGeometry.coordinates.map(coord => [coord[1], coord[0]])\r\n            : []\r\n        , [busRouteGeometry]);\r\n\r\n    // Process separate segments\r\n    const busSegments = busRouteSegments.map((seg, idx) => ({\r\n        id: idx,\r\n        positions: seg.coordinates.map(coord => [coord[1], coord[0]]),\r\n        color: seg.color || '#3b82f6',\r\n        dashArray: seg.type === 'walk' ? '10, 10' : null\r\n    }));\r\n\r\n    // Convert walking geometries\r\n    const walkingRoutes = walkingGeometries.map(geom =>\r\n        geom ? geom.coordinates.map(coord => [coord[1], coord[0]]) : []\r\n    ).filter(route => route.length > 0);\r\n\r\n    // Apply arrowheads when polyline updates\r\n    React.useEffect(() => {\r\n        const applyArrowheads = (ref) => {\r\n            if (ref.current) {\r\n                try {\r\n                    ref.current.arrowheads({\r\n                        yawn: 60,\r\n                        size: '15px',\r\n                        frequency: '50px',\r\n                        fill: true\r\n                    });\r\n                } catch {\r\n                    // console.warn(\"Failed to add arrowheads\", e);\r\n                }\r\n            }\r\n        };\r\n\r\n        applyArrowheads(busPolylineRef);\r\n\r\n        // Apply to all route polyline segments\r\n        Object.values(routePolylineRefs.current).forEach(ref => {\r\n            if (ref) applyArrowheads({ current: ref });\r\n        });\r\n\r\n        // Apply to all new segments\r\n        Object.values(segmentRefs.current).forEach(ref => {\r\n            if (ref) applyArrowheads({ current: ref });\r\n        });\r\n\r\n    }, [routeGeometry, busRouteGeometry, busRouteSegments]);\r\n\r\n    // Calculate bounds with coordinate sanitization\r\n    const bounds = React.useMemo(() => {\r\n        const allPositions = [\r\n            ...polylinePositions.flat(),\r\n            ...busRoutePositions,\r\n            ...walkingRoutes.flat(),\r\n            ...busSegments.flatMap(s => s.positions)\r\n        ].filter(pos => pos && pos[0] !== 0 && pos[1] !== 0 && !isNaN(pos[0]) && !isNaN(pos[1]));\r\n\r\n        if (allPositions.length > 0) {\r\n            return L.latLngBounds(allPositions);\r\n        } else if (stops.length > 0) {\r\n            const validStopCoords = stops\r\n                .map(s => [s.lat, s.lon])\r\n                .filter(pos => pos[0] !== 0 && pos[1] !== 0 && !isNaN(pos[0]) && !isNaN(pos[1]));\r\n\r\n            if (validStopCoords.length > 0) {\r\n                return L.latLngBounds(validStopCoords);\r\n            }\r\n        }\r\n        return null;\r\n    }, [polylinePositions, busRoutePositions, walkingRoutes, busSegments, stops]);\r\n\r\n    return (\r\n        <div style={{ height: '100%', width: '100%', position: 'relative', zIndex: 0 }}>\r\n            <MapContainer\r\n                center={defaultCenter}\r\n                zoom={15}\r\n                maxZoom={22}\r\n                minZoom={3}\r\n                style={{ height: '100%', width: '100%', background: '#1a1a1a' }}\r\n                zoomControl={false}\r\n                renderer={L.svg({ padding: 1.5 })}\r\n            >\r\n                <MapResizeHandler />\r\n                <TileLayer\r\n                    attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\r\n                    url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\r\n                    maxNativeZoom={19}\r\n                    maxZoom={22}\r\n                    keepBuffer={4}\r\n                    updateWhenIdle={false}\r\n                    updateWhenZooming={false}\r\n                />\r\n\r\n                {/* Draw Route Polyline (route explorer mode) */}\r\n                {polylinePositions.map((positions, idx) => (\r\n                    <Polyline\r\n                        key={`route-${idx}`}\r\n                        ref={el => routePolylineRefs.current[idx] = el}\r\n                        positions={positions}\r\n                        pathOptions={{ color: routeColor, weight: 5, opacity: 0.7 }}\r\n                    />\r\n                ))}\r\n\r\n                {/* Draw All Routes (when All Routes mode is selected) */}\r\n                {allRouteGeometries.map((routeData, idx) => {\r\n                    if (!routeData.geometry || !routeData.geometry.coordinates) return null;\r\n                    const positions = routeData.geometry.coordinates.map(coord => [coord[1], coord[0]]);\r\n                    return (\r\n                        <Polyline\r\n                            key={`all-route-${idx}`}\r\n                            positions={positions}\r\n                            pathOptions={{ color: routeData.color, weight: 4, opacity: 0.6 }}\r\n                        />\r\n                    );\r\n                })}\r\n\r\n                {/* Draw Walking Routes (directions mode) - Green dashed */}\r\n                {walkingRoutes.map((route, index) => (\r\n                    <Polyline\r\n                        key={`walk-${index}`}\r\n                        positions={route}\r\n                        pathOptions={{\r\n                            color: '#22c55e',\r\n                            weight: 4,\r\n                            opacity: 0.8,\r\n                            dashArray: '10, 10'\r\n                        }}\r\n                    />\r\n                ))}\r\n\r\n                {/* Draw Legacy Bus Route */}\r\n                {busRoutePositions.length > 0 && (\r\n                    <Polyline\r\n                        ref={busPolylineRef}\r\n                        positions={busRoutePositions}\r\n                        pathOptions={{ color: routeColor, weight: 5, opacity: 0.8 }}\r\n                    />\r\n                )}\r\n\r\n                {/* Draw Multi-Colored Bus Segments */}\r\n                {busSegments.map((seg) => (\r\n                    <Polyline\r\n                        key={`bus-seg-${seg.id}`}\r\n                        ref={el => segmentRefs.current[seg.id] = el}\r\n                        positions={seg.positions}\r\n                        pathOptions={{\r\n                            color: seg.color,\r\n                            weight: 5,\r\n                            opacity: 0.8,\r\n                            dashArray: seg.dashArray\r\n                        }}\r\n                    />\r\n                ))}\r\n\r\n                {/* User Location Marker */}\r\n                {userLocation && (\r\n                    <Marker position={[userLocation.lat, userLocation.lon]} icon={userIcon}>\r\n                        <Popup>📍 Your Location</Popup>\r\n                    </Marker>\r\n                )}\r\n\r\n                {/* Directions Markers */}\r\n                {directionsMarkers && (\r\n                    <>\r\n                        {directionsMarkers.originStop && (\r\n                            <CircleMarker\r\n                                center={[directionsMarkers.originStop.lat, directionsMarkers.originStop.lon]}\r\n                                radius={8}\r\n                                pathOptions={{ color: '#22c55e', fillColor: '#22c55e', fillOpacity: 1 }}\r\n                            >\r\n                                <Popup>🚏 Board here: {directionsMarkers.originStop.name}</Popup>\r\n                            </CircleMarker>\r\n                        )}\r\n                        {directionsMarkers.destStop && (\r\n                            <CircleMarker\r\n                                center={[directionsMarkers.destStop.lat, directionsMarkers.destStop.lon]}\r\n                                radius={8}\r\n                                pathOptions={{ color: '#ef4444', fillColor: '#ef4444', fillOpacity: 1 }}\r\n                            >\r\n                                <Popup>🚏 Alight here: {directionsMarkers.destStop.name}</Popup>\r\n                            </CircleMarker>\r\n                        )}\r\n                        {directionsMarkers.destination && (\r\n                            <Marker\r\n                                position={[directionsMarkers.destination.lat, directionsMarkers.destination.lon]}\r\n                                icon={destinationIcon}\r\n                            >\r\n                                <Popup>📍 {directionsMarkers.destination.name}</Popup>\r\n                            </Marker>\r\n                        )}\r\n                    </>\r\n                )}\r\n\r\n                {/* Draw Stops */}\r\n                {stops.map(stop => {\r\n                    const stopRoutes = getRoutesForStop(stop.id);\r\n\r\n                    return (\r\n                        <Marker\r\n                            key={stop.id}\r\n                            position={[stop.lat, stop.lon]}\r\n                            icon={busStopIcon}\r\n                            zIndexOffset={100}\r\n                        >\r\n                            <Popup autoPan={false} closeButton={true} className=\"custom-popup\">\r\n                                <div className=\"font-display\" style={{\r\n                                    backgroundColor: '#1a2633',\r\n                                    color: '#e5e7eb',\r\n                                    padding: '8px 4px',\r\n                                    borderRadius: '8px',\r\n                                    minWidth: '160px'\r\n                                }}>\r\n                                    <h3 style={{\r\n                                        margin: '0 0 8px 0',\r\n                                        fontSize: '14px',\r\n                                        fontWeight: '700',\r\n                                        color: '#ffffff',\r\n                                        lineHeight: '1.2'\r\n                                    }}>\r\n                                        {stop.name}\r\n                                    </h3>\r\n\r\n                                    {/* Next Arrival (only when showArrivalInfo is enabled) */}\r\n                                    {showArrivalInfo && selectedRouteName && (() => {\r\n                                        const arrival = getNextArrival(stop.id, selectedRouteName, selectedHeadsign);\r\n                                        if (!arrival) return null;\r\n                                        return (\r\n                                            <div style={{\r\n                                                marginBottom: '8px',\r\n                                                padding: '6px 8px',\r\n                                                backgroundColor: 'rgba(34, 197, 94, 0.15)',\r\n                                                borderRadius: '6px',\r\n                                                border: '1px solid rgba(34, 197, 94, 0.3)'\r\n                                            }}>\r\n                                                <div style={{\r\n                                                    display: 'flex',\r\n                                                    alignItems: 'center',\r\n                                                    gap: '6px'\r\n                                                }}>\r\n                                                    <span style={{\r\n                                                        backgroundColor: getRouteColor(selectedRouteName),\r\n                                                        color: '#fff',\r\n                                                        fontWeight: '700',\r\n                                                        fontSize: '11px',\r\n                                                        padding: '2px 8px',\r\n                                                        borderRadius: '9999px',\r\n                                                        minWidth: '20px',\r\n                                                        textAlign: 'center'\r\n                                                    }}>\r\n                                                        {selectedRouteName.replace('Route ', '')}\r\n                                                    </span>\r\n                                                    <span style={{\r\n                                                        color: '#22c55e',\r\n                                                        fontWeight: '700',\r\n                                                        fontSize: '13px'\r\n                                                    }}>\r\n                                                        {arrival.minsUntil <= 1 ? 'Arriving now' : `${arrival.minsUntil} min`}\r\n                                                    </span>\r\n                                                    <span style={{\r\n                                                        color: '#9ca3af',\r\n                                                        fontSize: '11px',\r\n                                                        marginLeft: 'auto'\r\n                                                    }}>\r\n                                                        @ {arrival.time}\r\n                                                    </span>\r\n                                                </div>\r\n                                            </div>\r\n                                        );\r\n                                    })()}\r\n\r\n                                    {/* Transfers / Other Routes */}\r\n                                    {(() => {\r\n                                        const transferRoutes = showArrivalInfo && selectedRouteName\r\n                                            ? stopRoutes.filter(r => r.name !== selectedRouteName)\r\n                                            : stopRoutes;\r\n                                        const label = showArrivalInfo && selectedRouteName ? 'TRANSFERS:' : 'BUSES:';\r\n\r\n                                        // Consolidate Route E variants into single \"E\" entry\r\n                                        const consolidatedRoutes = [];\r\n                                        const seenBaseRoutes = new Set();\r\n\r\n                                        transferRoutes.forEach(route => {\r\n                                            // Extract base route name (e.g., \"Route E\" from \"Route E(JA)\")\r\n                                            const baseName = route.name.replace(/\\([^)]+\\)/g, '').trim();\r\n\r\n                                            if (!seenBaseRoutes.has(baseName)) {\r\n                                                seenBaseRoutes.add(baseName);\r\n                                                consolidatedRoutes.push({\r\n                                                    ...route,\r\n                                                    displayName: baseName,\r\n                                                    originalName: route.name\r\n                                                });\r\n                                            }\r\n                                        });\r\n\r\n                                        return (\r\n                                            <div style={{\r\n                                                display: 'flex',\r\n                                                alignItems: 'baseline',\r\n                                                gap: '6px',\r\n                                                fontSize: '12px'\r\n                                            }}>\r\n                                                <span style={{\r\n                                                    color: '#9ca3af',\r\n                                                    fontWeight: '500',\r\n                                                    textTransform: 'uppercase',\r\n                                                    letterSpacing: '0.05em',\r\n                                                    fontSize: '10px'\r\n                                                }}>\r\n                                                    {label}\r\n                                                </span>\r\n                                                {consolidatedRoutes.length > 0 ? (\r\n                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>\r\n                                                        {consolidatedRoutes.map(route => {\r\n                                                            const routeNameShort = route.displayName.replace('Route ', '');\r\n                                                            return (\r\n                                                                <span\r\n                                                                    key={route.displayName}\r\n                                                                    onClick={() => onSelectRoute && onSelectRoute(route)}\r\n                                                                    style={{\r\n                                                                        backgroundColor: 'rgba(30, 64, 175, 0.3)',\r\n                                                                        border: '1px solid rgba(59, 130, 246, 0.3)',\r\n                                                                        color: getRouteColor(route.displayName),\r\n                                                                        fontWeight: '700',\r\n                                                                        cursor: 'pointer',\r\n                                                                        padding: '2px 10px',\r\n                                                                        borderRadius: '9999px',\r\n                                                                        fontSize: '11px',\r\n                                                                        transition: 'all 0.2s'\r\n                                                                    }}\r\n                                                                >\r\n                                                                    {routeNameShort}\r\n                                                                </span>\r\n                                                            );\r\n                                                        })}\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <span style={{ color: '#6b7280', fontStyle: 'italic' }}>None</span>\r\n                                                )}\r\n                                            </div>\r\n                                        );\r\n                                    })()}\r\n                                </div>\r\n                            </Popup>\r\n                        </Marker>\r\n                    );\r\n                })}\r\n\r\n                {bounds && <MapUpdater bounds={bounds} />}\r\n\r\n                {/* External zoom/center control handler */}\r\n                <MapControlHandler userLocation={userLocation} />\r\n\r\n                {/* Map Click Handler for Pin Mode */}\r\n                <MapClickHandler pinMode={pinMode} onMapClick={onMapClick} />\r\n\r\n                {/* Pinned Location Marker */}\r\n                {pinnedLocation && (\r\n                    <Marker\r\n                        position={[pinnedLocation.lat, pinnedLocation.lon]}\r\n                        icon={pinnedLocation.type === 'origin' ? pinnedOriginIcon : pinnedDestinationIcon}\r\n                    >\r\n                        <Popup>\r\n                            📍 {pinnedLocation.type === 'origin' ? 'Start' : 'Destination'}: Pinned Location\r\n                            <br />\r\n                            <span style={{ fontSize: '11px', color: '#666' }}>\r\n                                {pinnedLocation.lat.toFixed(6)}, {pinnedLocation.lon.toFixed(6)}\r\n                            </span>\r\n                        </Popup>\r\n                    </Marker>\r\n                )}\r\n            </MapContainer>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MapComponent;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\ReportDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\RouteSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\ScheduleView.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'stopIds' conditional could make the dependencies of useMemo Hook (at line 75) change on every render. Move it inside the useMemo callback. Alternatively, wrap the initialization of 'stopIds' in its own useMemo() Hook.","line":24,"column":11,"nodeType":"VariableDeclarator","endLine":24,"endColumn":66}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo } from 'react';\r\n\r\n// Average Bus Speed in m/s (approx 30km/h)\r\n// Adjust this factor to tune the \"Arrival Time\" estimation\r\nconst BUS_SPEED_MPS = 8.33;\r\nconst STOP_DWELL_TIME_SEC = 30; // 30 seconds per stop\r\n\r\n// Helper: Haversine Distance (pure function, no need to be inside the component)\r\nconst getDistance = (lat1, lon1, lat2, lon2) => {\r\n    const R = 6371000;\r\n    const dLat = (lat2 - lat1) * Math.PI / 180;\r\n    const dLon = (lon2 - lon1) * Math.PI / 180;\r\n    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\r\n        Math.sin(dLon / 2) * Math.sin(dLon / 2);\r\n    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n};\r\n\r\nconst ScheduleView = ({ service, stops = [], currentHeadsign }) => {\r\n    // Derive display trip and stop list unconditionally (before any hooks)\r\n    const displayTrip = service\r\n        ? (service.trips.find(t => t.headsign === currentHeadsign) || service.trips[0])\r\n        : null;\r\n    const stopIds = displayTrip ? displayTrip.stops_sequence : [];\r\n\r\n    // Calculate Arrival Times based on the first departure time\r\n    const scheduleItems = useMemo(() => {\r\n        if (!displayTrip || !displayTrip.times || displayTrip.times.length === 0) return [];\r\n\r\n        const startTimeStr = displayTrip.times[0]; // e.g., \"07:30\"\r\n        const [startH, startM] = startTimeStr.split(':').map(Number);\r\n        let currentSeconds = startH * 3600 + startM * 60;\r\n\r\n        // Resolve stop objects\r\n        const resolvedStops = stopIds.map(id => stops.find(s => s.id === id)).filter(Boolean);\r\n\r\n        return resolvedStops.map((stop, index) => {\r\n            // New Backend Logic: Use pre-calculated offsets from 'enrichSchedule'\r\n            if (displayTrip.arrival_offsets && displayTrip.arrival_offsets[index] !== undefined) {\r\n                const offsetMins = displayTrip.arrival_offsets[index];\r\n                const totalMins = startH * 60 + startM + offsetMins;\r\n                const h = Math.floor(totalMins / 60) % 24;\r\n                const m = totalMins % 60;\r\n                const timeStr = `${h}:${m.toString().padStart(2, '0')}`;\r\n\r\n                return {\r\n                    ...stop,\r\n                    calculatedTime: timeStr\r\n                };\r\n            }\r\n\r\n            // Fallback: Client-side estimation\r\n            let arrivalTimeStr = \"\";\r\n\r\n            if (index === 0) {\r\n                arrivalTimeStr = startTimeStr;\r\n            } else {\r\n                const prev = resolvedStops[index - 1];\r\n                const dist = getDistance(prev.lat, prev.lon, stop.lat, stop.lon);\r\n                const travelTime = dist / BUS_SPEED_MPS; // seconds\r\n\r\n                currentSeconds += travelTime + STOP_DWELL_TIME_SEC;\r\n\r\n                const h = Math.floor(currentSeconds / 3600) % 24;\r\n                const m = Math.floor((currentSeconds % 3600) / 60);\r\n                const mm = m.toString().padStart(2, '0');\r\n                arrivalTimeStr = `${h}:${mm}`;\r\n            }\r\n\r\n            return {\r\n                ...stop,\r\n                calculatedTime: arrivalTimeStr\r\n            };\r\n        });\r\n    }, [displayTrip, stopIds, stops]);\r\n\r\n    // Early return after all hooks have been called\r\n    if (!service) return (\r\n        <div style={{ padding: '1.5rem', textAlign: 'center', color: 'var(--text-muted)' }}>\r\n            No schedule available\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"schedule-view\">\r\n            <div className=\"schedule-header\">\r\n                <div>\r\n                    <h3 className=\"schedule-title\">{displayTrip?.headsign || \"Route Schedule\"}</h3>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"timeline-container\">\r\n                <div className=\"timeline-track\"></div>\r\n\r\n                {scheduleItems.map((item, index) => (\r\n                    <div key={index} className={`timeline-item ${index === 0 ? 'active' : ''}`}>\r\n                        <div className=\"timeline-dot\"></div>\r\n                        <div className=\"timeline-content\">\r\n                            <div>\r\n                                <p className=\"stop-name\">{item.name || item.id}</p>\r\n                            </div>\r\n                            <span className=\"stop-time\">\r\n                                {item.calculatedTime}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Departure Chips */}\r\n            <div style={{ marginTop: '1.5rem' }}>\r\n                <p className=\"section-title\">All Departures</p>\r\n                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>\r\n                    {displayTrip?.times?.map((time, idx) => (\r\n                        <span key={idx} style={{\r\n                            fontSize: '0.75rem',\r\n                            padding: '4px 8px',\r\n                            borderRadius: '4px',\r\n                            background: 'var(--surface-dark)',\r\n                            border: '1px solid var(--border-color)',\r\n                            color: 'var(--text-muted)'\r\n                        }}>\r\n                            {time}\r\n                        </span>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            <div style={{ marginTop: '1.5rem', display: 'flex', gap: '8px' }}>\r\n                <button className=\"mode-btn active\" style={{ flex: 1, justifyContent: 'center' }}>\r\n                    View Full Timetable\r\n                </button>\r\n                <button className=\"mode-btn\" style={{ width: '40px', justifyContent: 'center' }}>\r\n                    <span className=\"material-icons-round\">print</span>\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ScheduleView;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\SearchBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\ServiceSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\BottomNavigation.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileApp.jsx","messages":[],"suppressedMessages":[{"ruleId":"no-fallthrough","severity":2,"message":"Expected a 'break' statement before 'default'.","line":250,"column":9,"nodeType":"SwitchCase","messageId":"default","endLine":274,"endColumn":15,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileHomePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileInfoPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileNavigatePage.jsx","messages":[{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  108 |     // Use a ref to detect identity change without setState-in-effect.\n  109 |     const prevDirectionsRef = React.useRef(directions);\n> 110 |     if (prevDirectionsRef.current !== directions) {\n      |         ^^^^^^^^^^^^^^^^^^^^^^^^^ Cannot access ref value during render\n  111 |         prevDirectionsRef.current = directions;\n  112 |         // Only collapse when directions is newly set (not cleared)\n  113 |         if (directions && isExpanded) {","line":110,"column":9,"nodeType":null,"endLine":110,"endColumn":34},{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  109 |     const prevDirectionsRef = React.useRef(directions);\n  110 |     if (prevDirectionsRef.current !== directions) {\n> 111 |         prevDirectionsRef.current = directions;\n      |         ^^^^^^^^^^^^^^^^^^^^^^^^^ Cannot update ref during render\n  112 |         // Only collapse when directions is newly set (not cleared)\n  113 |         if (directions && isExpanded) {\n  114 |             // Schedule state update outside the render phase","line":111,"column":9,"nodeType":null,"endLine":111,"endColumn":34}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport BottomNavigation from './BottomNavigation';\r\nimport MapComponent from '../Map';\r\n\r\nconst MobileNavigatePage = ({\r\n    activeTab,\r\n    onTabChange,\r\n    onOpenSearch,\r\n    userLocation,\r\n    selectedOrigin,\r\n    selectedDestination,\r\n    mode,\r\n    visibleStops,\r\n    selectedStopIds,\r\n    routeGeometry,\r\n    walkingGeometries,\r\n    busRouteGeometry,\r\n    busRouteSegments,\r\n    directionsMarkers,\r\n    directions,\r\n    loading,\r\n    onClose,\r\n    onPlanFutureTrip,\r\n    // Pin mode props\r\n    pinMode = null,             // 'origin' | 'destination' | null\r\n    pinnedLocation = null,      // { lat, lon, type }\r\n    onMapClick = null,          // (lat, lon, type) => void\r\n    onConfirmPin = null,        // () => void\r\n    onCancelPin = null          // () => void\r\n}) => {\r\n    const [isExpanded, setIsExpanded] = useState(false);\r\n    const [startY, setStartY] = useState(null);\r\n    const [currentY, setCurrentY] = useState(null);\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [expandedSteps, setExpandedSteps] = useState({});\r\n\r\n    const toggleStep = (index) => {\r\n        setExpandedSteps(prev => ({\r\n            ...prev,\r\n            [index]: !prev[index]\r\n        }));\r\n    };\r\n\r\n    const handleTouchStart = (e) => {\r\n        setStartY(e.touches[0].clientY);\r\n        setIsDragging(true);\r\n    };\r\n\r\n    const handleTouchMove = (e) => {\r\n        if (!isDragging) return;\r\n        setCurrentY(e.touches[0].clientY);\r\n    };\r\n\r\n    const handleTouchEnd = () => {\r\n        setIsDragging(false);\r\n        if (startY !== null && currentY !== null) {\r\n            const diff = startY - currentY;\r\n            if (Math.abs(diff) > 50) { // Threshold\r\n                if (diff > 0) {\r\n                    setIsExpanded(true); // Swipe Up\r\n                } else {\r\n                    setIsExpanded(false); // Swipe Down\r\n                }\r\n            }\r\n        }\r\n        setStartY(null);\r\n        setCurrentY(null);\r\n    };\r\n\r\n    const getSheetHeight = () => {\r\n        const screenH = window.innerHeight;\r\n        const minHeight = 220; // Increased height for spaciousness\r\n        const maxHeight = screenH - 180;\r\n\r\n        if (isDragging && startY !== null && currentY !== null) {\r\n            const baseH = isExpanded ? maxHeight : minHeight;\r\n            const diff = startY - currentY;\r\n            let newH = baseH + diff;\r\n            if (newH < minHeight) newH = minHeight;\r\n            if (newH > maxHeight) newH = maxHeight;\r\n            return `${newH}px`;\r\n        }\r\n        return isExpanded ? `${maxHeight}px` : `${minHeight}px`;\r\n    };\r\n\r\n    const getETA = () => {\r\n        if (!directions?.summary?.totalDuration) return null;\r\n        const now = new Date();\r\n        const eta = new Date(now.getTime() + directions.summary.totalDuration * 60000);\r\n        return eta.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });\r\n    };\r\n\r\n    const getWalkingTime = () => {\r\n        if (!directions?.steps) return 0;\r\n        const walkDuration = directions.steps\r\n            .filter(step => step.type === 'walk')\r\n            .reduce((acc, step) => acc + step.duration, 0);\r\n\r\n        // Also add walking route duration if WALK_ONLY\r\n        if (directions.type === 'WALK_ONLY' && directions.summary) {\r\n            return Math.round(directions.summary.totalDuration);\r\n        }\r\n\r\n        return Math.round(walkDuration);\r\n    };\r\n\r\n    // Auto-minimize (collapse) when new directions arrive.\r\n    // Use a ref to detect identity change without setState-in-effect.\r\n    const prevDirectionsRef = React.useRef(directions);\r\n    if (prevDirectionsRef.current !== directions) {\r\n        prevDirectionsRef.current = directions;\r\n        // Only collapse when directions is newly set (not cleared)\r\n        if (directions && isExpanded) {\r\n            // Schedule state update outside the render phase\r\n            Promise.resolve().then(() => setIsExpanded(false));\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"relative h-screen w-full flex flex-col group/design-root overflow-hidden max-w-md mx-auto bg-[#101922]\">\r\n            {/* MAP BACKGROUND LAYER */}\r\n            <div className=\"absolute inset-0 z-0\">\r\n                <MapComponent\r\n                    stops={visibleStops || []}\r\n                    selectedRouteStops={selectedStopIds || []}\r\n                    routeGeometry={mode === 'explore' ? routeGeometry : null}\r\n                    walkingGeometries={mode === 'directions' ? walkingGeometries : []}\r\n                    busRouteGeometry={mode === 'directions' ? busRouteGeometry : null}\r\n                    busRouteSegments={mode === 'directions' ? busRouteSegments : []}\r\n                    userLocation={userLocation}\r\n                    directionsMarkers={directionsMarkers}\r\n                    onMapClick={onMapClick}\r\n                    pinnedLocation={pinnedLocation}\r\n                    pinMode={pinMode}\r\n                />\r\n            </div>\r\n\r\n            {/* TOP APP BAR */}\r\n            <div className=\"absolute top-0 left-0 w-full z-30 p-4 pt-4 bg-[#101922]/90 backdrop-blur-md shadow-sm\">\r\n                <div className=\"flex flex-col gap-3\">\r\n                    {/* Search Inputs */}\r\n                    <div className=\"space-y-2\">\r\n                        <button\r\n                            onClick={() => onOpenSearch('origin')}\r\n                            className=\"w-full flex items-center gap-3 bg-[#1a2633] rounded-xl px-4 py-3 shadow-sm border border-gray-800\"\r\n                        >\r\n                            <div className=\"w-2 h-2 rounded-full bg-blue-500 shrink-0 shadow-[0_0_8px_rgba(59,130,246,0.5)]\"></div>\r\n                            <span className=\"text-gray-300 font-medium truncate\">\r\n                                {directions?.origin?.name || selectedOrigin?.name || 'Your Location'}\r\n                            </span>\r\n                        </button>\r\n\r\n                        <div className=\"w-0.5 h-3 bg-gray-700 mx-6 rounded-full dark:bg-gray-800\"></div>\r\n\r\n                        <button\r\n                            onClick={() => onOpenSearch('destination')}\r\n                            className=\"w-full flex items-center gap-3 bg-[#1a2633] rounded-xl px-4 py-3 shadow-sm border border-gray-800\"\r\n                        >\r\n                            <div className=\"w-2 h-2 rounded-full bg-red-500 shrink-0 shadow-[0_0_8px_rgba(239,68,68,0.5)]\"></div>\r\n                            <span className=\"text-white font-medium truncate\">\r\n                                {directions?.destination?.name || selectedDestination?.name || 'Where to?'}\r\n                            </span>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* MAP CONTROLS (Floating Right) - z-5 to be behind direction sheet (z-10) */}\r\n            {!isExpanded && (\r\n                <div className=\"absolute right-4 top-1/2 -translate-y-1/2 z-[5] flex flex-col gap-3\">\r\n                    <div className=\"flex flex-col gap-0.5 rounded-lg shadow-lg overflow-hidden bg-white dark:bg-[#1e293b]\">\r\n                        <button\r\n                            onClick={() => {\r\n                                // Zoom in - dispatch custom event to map\r\n                                window.dispatchEvent(new CustomEvent('map-zoom', { detail: { direction: 'in' } }));\r\n                            }}\r\n                            className=\"flex size-10 items-center justify-center bg-white dark:bg-[#1e293b] hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:scale-95\"\r\n                        >\r\n                            <span className=\"material-symbols-outlined text-gray-800 dark:text-white\">add</span>\r\n                        </button>\r\n                        <div className=\"h-[1px] w-full bg-gray-200 dark:bg-gray-600\"></div>\r\n                        <button\r\n                            onClick={() => {\r\n                                // Zoom out - dispatch custom event to map\r\n                                window.dispatchEvent(new CustomEvent('map-zoom', { detail: { direction: 'out' } }));\r\n                            }}\r\n                            className=\"flex size-10 items-center justify-center bg-white dark:bg-[#1e293b] hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:scale-95\"\r\n                        >\r\n                            <span className=\"material-symbols-outlined text-gray-800 dark:text-white\">remove</span>\r\n                        </button>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => {\r\n                            // Center on user location - dispatch custom event\r\n                            window.dispatchEvent(new CustomEvent('map-center-user'));\r\n                        }}\r\n                        className=\"flex size-10 items-center justify-center rounded-lg bg-white dark:bg-[#1e293b] shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:scale-95\"\r\n                    >\r\n                        <span className=\"material-symbols-outlined text-primary\">my_location</span>\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* LOADING STATE overlay */}\r\n            {loading && (\r\n                <div className=\"absolute inset-0 z-40 bg-black/20 backdrop-blur-sm flex items-center justify-center pointer-events-none\">\r\n                    <div className=\"bg-[#101922] rounded-2xl shadow-lg p-6 border border-gray-800 flex flex-col items-center justify-center gap-3 pointer-events-auto\">\r\n                        <div className=\"w-8 h-8 border-4 border-primary/30 border-t-primary rounded-full animate-spin\"></div>\r\n                        <p className=\"text-gray-500 font-medium text-sm\">Finding best route...</p>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* PIN MODE OVERLAY */}\r\n            {pinMode && (\r\n                <div className=\"absolute inset-x-0 bottom-24 z-30 px-4\">\r\n                    <div className=\"bg-[#101922] rounded-2xl shadow-lg p-4 border border-gray-800\">\r\n                        {/* Header */}\r\n                        <div className=\"flex items-center gap-3 mb-3\">\r\n                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${pinMode === 'origin' ? 'bg-blue-500/20' : 'bg-red-500/20'}`}>\r\n                                <span className=\"material-symbols-outlined text-xl\" style={{ color: pinMode === 'origin' ? '#3b82f6' : '#ef4444' }}>\r\n                                    {pinMode === 'origin' ? 'trip_origin' : 'location_on'}\r\n                                </span>\r\n                            </div>\r\n                            <div className=\"flex-1\">\r\n                                <h3 className=\"text-white font-semibold\">\r\n                                    {pinMode === 'origin' ? 'Pin Start Location' : 'Pin Destination'}\r\n                                </h3>\r\n                                <p className=\"text-gray-400 text-sm\">\r\n                                    {pinnedLocation ? 'Tap confirm or tap map to change' : 'Tap anywhere on the map'}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Pinned Location Info */}\r\n                        {pinnedLocation && (\r\n                            <div className=\"bg-[#1a2633] rounded-xl p-3 mb-3 border border-gray-700\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <span className=\"material-symbols-outlined text-sm\" style={{ color: pinMode === 'origin' ? '#3b82f6' : '#ef4444' }}>\r\n                                        push_pin\r\n                                    </span>\r\n                                    <span className=\"text-white text-sm font-medium\">Pinned Location</span>\r\n                                </div>\r\n                                <p className=\"text-gray-400 text-xs mt-1\">\r\n                                    {pinnedLocation.lat.toFixed(6)}, {pinnedLocation.lon.toFixed(6)}\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Action Buttons */}\r\n                        <div className=\"flex gap-2\">\r\n                            <button\r\n                                onClick={onCancelPin}\r\n                                className=\"flex-1 py-2.5 rounded-xl bg-gray-800 text-gray-300 font-medium hover:bg-gray-700 transition-colors\"\r\n                            >\r\n                                Cancel\r\n                            </button>\r\n                            <button\r\n                                onClick={onConfirmPin}\r\n                                disabled={!pinnedLocation}\r\n                                className={`flex-1 py-2.5 rounded-xl font-medium transition-colors ${pinnedLocation\r\n                                    ? 'bg-blue-600 text-white hover:bg-blue-700'\r\n                                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'\r\n                                    }`}\r\n                            >\r\n                                Confirm\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* DIRECTIONS SHEET */}\r\n            {directions && !loading && (\r\n                <div\r\n                    className=\"absolute bottom-0 left-0 right-0 bg-[#101922] rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.15)] border-t border-gray-800 overflow-hidden flex flex-col z-10 transition-all ease-out\"\r\n                    style={{\r\n                        height: getSheetHeight(),\r\n                        transitionDuration: isDragging ? '0ms' : '300ms'\r\n                    }}\r\n                >\r\n                    {/* Drag Handle Area */}\r\n                    <div\r\n                        className=\"relative w-full shrink-0 cursor-grab active:cursor-grabbing touch-none px-5 pt-6 pb-2\"\r\n                        onTouchStart={handleTouchStart}\r\n                        onTouchMove={handleTouchMove}\r\n                        onTouchEnd={handleTouchEnd}\r\n                    >\r\n                        {/* Visual Pull Bar (Bigger) */}\r\n                        <div className=\"absolute top-3 left-1/2 -translate-x-1/2 w-20 h-2 bg-gray-700 rounded-full shadow-inner\"></div>\r\n\r\n                        {/* Summary Header */}\r\n                        <div className=\"flex flex-col gap-4\">\r\n                            {/* Title Row */}\r\n                            <div className=\"flex items-center justify-between\">\r\n                                <div className=\"flex-1 min-w-0 pr-2\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <h3 className=\"text-white text-lg font-bold truncate\">\r\n                                            {directions.destination?.name || 'Destination'}\r\n                                        </h3>\r\n                                        {directions.summary?.route && (\r\n                                            <span className=\"bg-blue-600/20 text-blue-400 border border-blue-400/20 px-2 py-0.5 rounded text-[10px] font-bold\">\r\n                                                {directions.summary.route}\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <button\r\n                                        onClick={(e) => { e.stopPropagation(); onClose(); }}\r\n                                        className=\"size-8 rounded-full bg-gray-800 flex items-center justify-center text-gray-500 hover:bg-gray-700 transition-colors\"\r\n                                    >\r\n                                        <span className=\"material-symbols-outlined text-lg\">close</span>\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Metrics Row - Spacious Flex Layout */}\r\n                            {directions.summary && (\r\n                                <div className=\"flex items-start justify-between gap-4 w-full\">\r\n                                    {/* Journey Time */}\r\n                                    <div className=\"flex flex-col min-w-0\">\r\n                                        <span className=\"text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 truncate\">Journey Time</span>\r\n                                        <span className=\"text-xl font-black text-white leading-none whitespace-nowrap\">~{Math.round(directions.summary.totalDuration)} min</span>\r\n                                    </div>\r\n\r\n                                    <div className=\"w-[1px] bg-gray-800 self-stretch my-1\"></div>\r\n\r\n                                    {/* Walking Info - Distance, Time, Incline */}\r\n                                    <div className=\"flex flex-col min-w-0\">\r\n                                        <span className=\"text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 truncate\">Walking</span>\r\n                                        <div className=\"flex items-center gap-2 flex-wrap\">\r\n                                            <span className=\"text-lg font-black text-gray-400 leading-none whitespace-nowrap\">{directions.totalWalkingDistance || 0}m</span>\r\n                                            <span className=\"text-sm font-bold text-gray-500\">~{getWalkingTime()} min</span>\r\n                                        </div>\r\n                                        {/* Incline info from first walk step */}\r\n                                        {directions.steps && directions.steps.find(s => s.type === 'walk') && (\r\n                                            (() => {\r\n                                                const walkSteps = directions.steps.filter(s => s.type === 'walk');\r\n                                                const totalAscent = walkSteps.reduce((acc, s) => acc + (s.ascent || 0), 0);\r\n                                                const totalDescent = walkSteps.reduce((acc, s) => acc + (s.descent || 0), 0);\r\n                                                if (totalAscent > 0 || totalDescent > 0) {\r\n                                                    return (\r\n                                                        <div className=\"flex items-center gap-2 mt-1\">\r\n                                                            {totalAscent > 0 && (\r\n                                                                <span className=\"text-[10px] text-green-500 flex items-center gap-0.5\">\r\n                                                                    <span className=\"material-symbols-outlined text-xs\">trending_up</span>\r\n                                                                    +{Math.round(totalAscent)}m\r\n                                                                </span>\r\n                                                            )}\r\n                                                            {totalDescent > 0 && (\r\n                                                                <span className=\"text-[10px] text-red-400 flex items-center gap-0.5\">\r\n                                                                    <span className=\"material-symbols-outlined text-xs\">trending_down</span>\r\n                                                                    -{Math.round(totalDescent)}m\r\n                                                                </span>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    );\r\n                                                }\r\n                                                return null;\r\n                                            })()\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    <div className=\"w-[1px] bg-gray-800 self-stretch my-1\"></div>\r\n\r\n                                    {/* Arrival Time */}\r\n                                    <div className=\"flex flex-col min-w-0\">\r\n                                        <span className=\"text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 truncate\">Arrival</span>\r\n                                        <span className=\"text-xl font-black text-blue-500 leading-none whitespace-nowrap\">{getETA() || '--:--'}</span>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Scrollable Content */}\r\n                    <div className={`flex-1 overflow-y-auto pb-[100px] transition-opacity duration-300 ${!isExpanded && !isDragging ? 'opacity-0' : 'opacity-100'}`}>\r\n                        {directions.error && (\r\n                            <div className=\"p-8 text-center\">\r\n                                <span className=\"material-symbols-outlined text-4xl text-red-400 mb-2\">error</span>\r\n                                <p className=\"text-red-500 font-medium mb-1\">{directions.error}</p>\r\n                                {directions.suggestion && <p className=\"text-sm text-gray-500\">{directions.suggestion}</p>}\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"px-4 pb-4 pt-0 space-y-6\">\r\n                            {directions.steps && (\r\n                                <div className=\"space-y-0 relative\">\r\n                                    <div className=\"absolute left-[15.5px] top-4 bottom-4 w-0.5 bg-gray-800\"></div>\r\n\r\n                                    {directions.steps.map((step, idx) => (\r\n                                        <div key={idx} className=\"flex flex-col relative group\">\r\n                                            <div className={`flex gap-4 items-start py-3 bg-[#101922] sticky top-0 z-20 transition-colors ${expandedSteps[idx] ? 'border-b border-gray-800' : ''}`}>\r\n                                                <div\r\n                                                    className=\"shrink-0 size-8 rounded-full bg-[#1a2633] border-2 flex items-center justify-center shadow-sm\"\r\n                                                    style={{\r\n                                                        borderColor: step.type === 'walk' ? '#22c55e' : (step.type === 'board' ? 'var(--border-color, #e5e7eb)' : 'transparent')\r\n                                                    }}\r\n                                                >\r\n                                                    <span className=\"material-symbols-outlined text-sm\" style={{ color: step.type === 'walk' ? '#22c55e' : (step.type === 'board' || step.type === 'transfer' ? '#3b82f6' : 'gray') }}>\r\n                                                        {step.type === 'walk' ? 'directions_walk' :\r\n                                                            step.type === 'board' ? 'directions_bus' :\r\n                                                                step.type === 'transfer' ? 'transfer_within_a_station' :\r\n                                                                    step.type === 'alight' ? 'location_on' : 'arrow_downward'}\r\n                                                    </span>\r\n                                                </div>\r\n                                                <div className=\"flex-1\">\r\n                                                    <p className=\"text-sm text-white font-medium leading-normal\">\r\n                                                        {step.instruction}\r\n                                                    </p>\r\n                                                    <div className=\"flex items-center gap-3 mt-1.5 opacity-80\">\r\n                                                        {step.time && (\r\n                                                            <span className=\"text-[11px] font-bold text-blue-400 bg-blue-900/20 px-1.5 py-0.5 rounded uppercase tracking-wider\">\r\n                                                                {step.time}\r\n                                                            </span>\r\n                                                        )}\r\n                                                        {step.duration > 0 && (\r\n                                                            <span className=\"text-xs text-gray-400 font-medium\">\r\n                                                                {step.duration} min\r\n                                                            </span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    {/* Walking Summary Stats - Visible before expanding */}\r\n                                                    {step.type === 'walk' && (\r\n                                                        <div className=\"flex items-center gap-3 mt-2 flex-wrap\">\r\n                                                            {step.distance && (\r\n                                                                <span className=\"text-[11px] text-gray-500 flex items-center gap-1\">\r\n                                                                    <span className=\"material-symbols-outlined text-xs\">straighten</span>\r\n                                                                    {step.distance}m\r\n                                                                </span>\r\n                                                            )}\r\n                                                            {step.duration > 0 && (\r\n                                                                <span className=\"text-[11px] text-gray-500 flex items-center gap-1\">\r\n                                                                    <span className=\"material-symbols-outlined text-xs\">schedule</span>\r\n                                                                    ~{step.duration} min\r\n                                                                </span>\r\n                                                            )}\r\n                                                            {step.ascent !== undefined && step.ascent > 0 && (\r\n                                                                <span className=\"text-[11px] text-green-500 flex items-center gap-1\">\r\n                                                                    <span className=\"material-symbols-outlined text-xs\">trending_up</span>\r\n                                                                    +{Math.round(step.ascent)}m\r\n                                                                </span>\r\n                                                            )}\r\n                                                            {step.descent !== undefined && step.descent > 0 && (\r\n                                                                <span className=\"text-[11px] text-red-400 flex items-center gap-1\">\r\n                                                                    <span className=\"material-symbols-outlined text-xs\">trending_down</span>\r\n                                                                    -{Math.round(step.descent)}m\r\n                                                                </span>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                                {/* Show/Hide Button */}\r\n                                                {step.type === 'walk' && step.details && step.details.length > 0 && (\r\n                                                    <button\r\n                                                        onClick={(e) => { e.stopPropagation(); toggleStep(idx); }}\r\n                                                        className=\"shrink-0 px-3 py-1.5 rounded-lg bg-gray-800 text-xs font-medium text-gray-300 border border-gray-700 active:bg-gray-700 transition-colors shadow-sm\"\r\n                                                    >\r\n                                                        {expandedSteps[idx] ? 'Hide' : 'Show'}\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n\r\n\r\n\r\n\r\n                                            {/* Expandable Details */}\r\n                                            {\r\n                                                step.type === 'walk' && expandedSteps[idx] && step.details && (\r\n                                                    <div className=\"ml-12 pl-4 border-l-2 border-dashed border-gray-700/50 space-y-3 py-2\">\r\n                                                        {step.details.map((detail, i) => (\r\n                                                            <div key={i} className=\"relative\">\r\n                                                                <div className=\"flex gap-3\">\r\n                                                                    <span className=\"material-symbols-outlined text-gray-500 text-sm mt-0.5\">\r\n                                                                        {detail.type === 'turn_left' ? 'turn_left' :\r\n                                                                            detail.type === 'turn_right' ? 'turn_right' :\r\n                                                                                'straight'}\r\n                                                                    </span>\r\n                                                                    <div>\r\n                                                                        <p className=\"text-xs text-gray-300\">{detail.instruction}</p>\r\n                                                                        <p className=\"text-[10px] text-gray-500\">{detail.distance}m</p>\r\n                                                                    </div>\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                )\r\n                                            }\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n\r\n                            {directions.type === 'WALK_ONLY' && !directions.error && (\r\n                                <div className=\"space-y-4\">\r\n                                    {/* Header - Adaptive Color based on Warning */}\r\n                                    <div className={`rounded-2xl p-4 text-center border ${directions.alternativeBus?.warning\r\n                                        ? 'bg-amber-50 dark:bg-amber-900/10 border-amber-100 dark:border-amber-900/20'\r\n                                        : 'bg-green-50 dark:bg-green-900/10 border-green-100 dark:border-green-900/20'\r\n                                        }`}>\r\n                                        <div className=\"flex items-center justify-center gap-3\">\r\n                                            <div className={`size-10 rounded-full flex items-center justify-center ${directions.alternativeBus?.warning\r\n                                                ? 'bg-amber-100 dark:bg-amber-900/30'\r\n                                                : 'bg-green-100 dark:bg-green-900/30'\r\n                                                }`}>\r\n                                                <span className={`material-symbols-outlined text-xl ${directions.alternativeBus?.warning\r\n                                                    ? 'text-amber-600 dark:text-amber-400'\r\n                                                    : 'text-green-600 dark:text-green-400'\r\n                                                    }`}>\r\n                                                    {directions.alternativeBus?.warning ? 'warning' : 'directions_walk'}\r\n                                                </span>\r\n                                            </div>\r\n                                            <div className=\"text-left\">\r\n                                                <p className={`${directions.alternativeBus?.warning\r\n                                                    ? 'text-amber-800 dark:text-amber-300'\r\n                                                    : 'text-green-800 dark:text-green-300'\r\n                                                    } font-semibold`}>\r\n                                                    {directions.message}\r\n                                                </p>\r\n                                                <p className={`text-sm ${directions.alternativeBus?.warning\r\n                                                    ? 'text-amber-600/80 dark:text-amber-400/60'\r\n                                                    : 'text-green-600/80 dark:text-green-400/60'\r\n                                                    }`}>\r\n                                                    {directions.totalWalkingDistance}m • ~{directions.totalDuration} min\r\n                                                </p>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Step-by-step directions */}\r\n                                    {directions.walkingSteps && directions.walkingSteps.length > 0 && (\r\n                                        <div className=\"space-y-0 relative\">\r\n                                            <div className=\"absolute left-[15.5px] top-4 bottom-4 w-0.5 bg-gray-800\"></div>\r\n\r\n                                            {directions.walkingSteps.map((step, idx) => (\r\n                                                <div key={idx} className=\"flex gap-4 relative py-2.5 group\">\r\n                                                    <div className=\"shrink-0 size-8 rounded-full bg-[#1a2633] border-2 border-green-500/30 flex items-center justify-center z-10 shadow-sm\">\r\n                                                        <span className=\"material-symbols-outlined text-sm text-green-400\">\r\n                                                            {step.type === 'turn_left' || step.type === 'turn_sharp_left' || step.type === 'turn_slight_left' ? 'turn_left' :\r\n                                                                step.type === 'turn_right' || step.type === 'turn_sharp_right' || step.type === 'turn_slight_right' ? 'turn_right' :\r\n                                                                    step.type === 'destination' ? 'location_on' :\r\n                                                                        step.type === 'depart' ? 'trip_origin' :\r\n                                                                            step.type === 'u_turn' ? 'u_turn_left' :\r\n                                                                                'arrow_upward'}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                    <div className=\"flex-1\">\r\n                                                        <p className=\"text-sm text-white font-medium leading-normal\">\r\n                                                            {step.instruction}\r\n                                                        </p>\r\n                                                        {step.distance > 0 && (\r\n                                                            <p className=\"text-xs text-gray-500 mt-0.5\">\r\n                                                                {step.distance}m\r\n                                                            </p>\r\n                                                        )}\r\n                                                    </div>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Alternative bus option - Only show if route found */}\r\n                                    {directions.alternativeBus && directions.alternativeBus.routeName && (\r\n                                        <div className=\"bg-blue-50 dark:bg-blue-900/10 rounded-xl p-4 border border-blue-100 dark:border-blue-900/20\">\r\n                                            <div className=\"flex justify-between items-center mb-2\">\r\n                                                <p className=\"text-xs text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wider\">Next Available Option</p>\r\n                                                {directions.alternativeBus.minutesUntil > 60 && (\r\n                                                    <span className=\"text-[10px] bg-blue-100 dark:bg-blue-900/40 text-blue-600 px-2 py-0.5 rounded-full font-bold\">\r\n                                                        Future Trip\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n\r\n                                            <div className=\"flex items-center justify-between\">\r\n                                                <div>\r\n                                                    <p className=\"text-base text-blue-900 dark:text-blue-100 font-bold\">\r\n                                                        Route {directions.alternativeBus.routeName}\r\n                                                    </p>\r\n                                                    {directions.alternativeBus.originName && (\r\n                                                        <p className=\"text-xs text-blue-800 dark:text-blue-200 font-medium mt-0.5\">\r\n                                                            From: {directions.alternativeBus.originName}\r\n                                                        </p>\r\n                                                    )}\r\n                                                    <p className=\"text-sm text-blue-700 dark:text-blue-300 mt-0.5\">\r\n                                                        {directions.alternativeBus.minutesUntil > 120\r\n                                                            ? `Departs at ${directions.alternativeBus.nextDeparture}`\r\n                                                            : `Arrives in ${directions.alternativeBus.minutesUntil} min`\r\n                                                        }\r\n                                                    </p>\r\n                                                </div>\r\n\r\n                                                {onPlanFutureTrip && (\r\n                                                    <button\r\n                                                        onClick={() => onPlanFutureTrip(directions.alternativeBus)}\r\n                                                        className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-lg transition-colors shadow-sm flex items-center gap-1\"\r\n                                                    >\r\n                                                        View Details\r\n                                                        <span className=\"material-symbols-outlined text-sm\">arrow_forward</span>\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div >\r\n                </div >\r\n            )\r\n            }\r\n\r\n            {/* BOTTOM NAVIGATION BAR */}\r\n            <div className=\"absolute bottom-0 w-full z-[20]\">\r\n                <BottomNavigation activeTab={activeTab} onTabChange={onTabChange} />\r\n            </div>\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default MobileNavigatePage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileProfilePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileRouteDetailPage.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'stopSequence' logical expression could make the dependencies of useMemo Hook (at line 108) change on every render. To fix this, wrap the initialization of 'stopSequence' in its own useMemo() Hook.","line":90,"column":11,"nodeType":"VariableDeclarator","endLine":90,"endColumn":59},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'stopSequence' logical expression could make the dependencies of useMemo Hook (at line 300) change on every render. To fix this, wrap the initialization of 'stopSequence' in its own useMemo() Hook.","line":90,"column":11,"nodeType":"VariableDeclarator","endLine":90,"endColumn":59},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  304 |     // Reset selection when direction changes\n  305 |     useEffect(() => {\n> 306 |         setSelectedTimeStr(null);\n      |         ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  307 |         setOpenSection(null);\n  308 |         // Reset variant when direction changes\n  309 |         if (isMergedRouteE) {","line":306,"column":9,"nodeType":null,"endLine":306,"endColumn":27},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  322 |             const nextDeparture = currentTrip.mergedTimes.find(entry => entry.time >= currentTimeStr);\n  323 |             if (nextDeparture) {\n> 324 |                 setSelectedVariant(nextDeparture.variant);\n      |                 ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  325 |             } else if (currentTrip.mergedTimes[0]) {\n  326 |                 // If no upcoming, use first variant\n  327 |                 setSelectedVariant(currentTrip.mergedTimes[0].variant);","line":324,"column":17,"nodeType":null,"endLine":324,"endColumn":35}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useEffect } from 'react';\r\nimport BottomNavigation from './BottomNavigation';\r\nimport MapComponent from '../Map';\r\nimport ReportDialog from '../ReportDialog';\r\nimport { getRouteColor } from '../../constants';\r\n\r\nconst MobileRouteDetailPage = ({ activeTab, onTabChange, route, routes, stops, onBack, userLocation, routeGeometry, onDirectionSelect, selectedServiceIndex }) => {\r\n    // 1. State Definitions\r\n    const [selectedDirection, setSelectedDirection] = useState(0);\r\n    const [isExpanded, setIsExpanded] = useState(false);\r\n    const [showReportDialog, setShowReportDialog] = useState(false);\r\n\r\n    // Pull to refresh/expand logic state\r\n    const [startY, setStartY] = useState(null);\r\n    const [currentY, setCurrentY] = useState(null);\r\n    const [isDragging, setIsDragging] = useState(false);\r\n\r\n    // Schedule view state\r\n    const [selectedTimeStr, setSelectedTimeStr] = useState(null);\r\n    const [openSection, setOpenSection] = useState(null);\r\n    const [showSchedule, setShowSchedule] = useState(false);\r\n\r\n    // State for selected variant (for merged Route E)\r\n    const [selectedVariant, setSelectedVariant] = useState(null);\r\n\r\n    // 2. Derived Values\r\n    const routeName = route?.displayName || route?.name || 'Route A';\r\n    const color = getRouteColor(routeName);\r\n    const isMergedRouteE = route?.isMerged && route?.name === 'Route E';\r\n    const serviceIdx = (selectedServiceIndex !== undefined && selectedServiceIndex >= 0) ? selectedServiceIndex : 0;\r\n\r\n    // 3. Complex Memos (Data Processing)\r\n\r\n    // For merged Route E, create unified trips that combine all variants by headsign\r\n    const unifiedTrips = useMemo(() => {\r\n        if (!isMergedRouteE || !route?.variants) {\r\n            return route?.services?.[serviceIdx]?.trips || [];\r\n        }\r\n\r\n        // Group trips by normalized headsign (e.g., \"To Cluster (T02)\" or \"To KDOJ\")\r\n        const headsignMap = new Map();\r\n\r\n        route.variants.forEach(variant => {\r\n            const weekdayService = variant.services?.find(s => s.service_id === 'WEEKDAY');\r\n            weekdayService?.trips?.forEach(trip => {\r\n                // Normalize headsign - some variants have slightly different names\r\n                let normalizedHeadsign = trip.headsign;\r\n\r\n                // Get or create entry for this headsign\r\n                if (!headsignMap.has(normalizedHeadsign)) {\r\n                    headsignMap.set(normalizedHeadsign, {\r\n                        headsign: normalizedHeadsign,\r\n                        stops_sequence: trip.stops_sequence, // Use first variant's stops as default\r\n                        times: [],\r\n                        arrival_offsets: trip.arrival_offsets,\r\n                        mergedTimes: [] // Array of { time, variant, variantLabel, stops_sequence, arrival_offsets }\r\n                    });\r\n                }\r\n\r\n                const entry = headsignMap.get(normalizedHeadsign);\r\n                const variantLabel = variant.name.match(/\\(([^)]+)\\)/)?.[1] || '';\r\n\r\n                // Add times with variant info\r\n                trip.times?.forEach(time => {\r\n                    entry.mergedTimes.push({\r\n                        time,\r\n                        variant: variant.name,\r\n                        variantLabel,\r\n                        stops_sequence: trip.stops_sequence,\r\n                        arrival_offsets: trip.arrival_offsets\r\n                    });\r\n                    // Also add to times array for backward compatibility\r\n                    if (!entry.times.includes(time)) {\r\n                        entry.times.push(time);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n\r\n        // Sort times and mergedTimes within each headsign and convert to array\r\n        return Array.from(headsignMap.values()).map(entry => ({\r\n            ...entry,\r\n            times: [...entry.times].sort(),\r\n            mergedTimes: entry.mergedTimes.sort((a, b) => a.time.localeCompare(b.time))\r\n        }));\r\n    }, [isMergedRouteE, route, serviceIdx]);\r\n\r\n    const trips = isMergedRouteE ? unifiedTrips : (route?.services?.[serviceIdx]?.trips || []);\r\n    const currentTrip = trips[selectedDirection] || trips[0];\r\n    const stopSequence = currentTrip?.stops_sequence || [];\r\n\r\n    // For merged Route E, find the actual variant route for geometry\r\n    const activeVariantRoute = useMemo(() => {\r\n        if (!isMergedRouteE || !selectedVariant) return null;\r\n        return route.variants?.find(v => v.name === selectedVariant);\r\n    }, [isMergedRouteE, selectedVariant, route]);\r\n\r\n    // Filter stops for map - use variant's stops if available\r\n    const mapStops = useMemo(() => {\r\n        if (activeVariantRoute && currentTrip) {\r\n            const variantService = activeVariantRoute.services?.find(s => s.service_id === 'WEEKDAY');\r\n            const variantTrip = variantService?.trips?.find(t => t.headsign === currentTrip?.headsign);\r\n            if (variantTrip?.stops_sequence) {\r\n                return stops.filter(s => variantTrip.stops_sequence.includes(s.id));\r\n            }\r\n        }\r\n        return stops.filter(s => stopSequence.includes(s.id));\r\n    }, [activeVariantRoute, stopSequence, stops, currentTrip]);\r\n\r\n    // Group times logic - handles merged Route E with variant labels\r\n    const groupedTimes = useMemo(() => {\r\n        const groups = { morning: [], afternoon: [], evening: [] };\r\n        const now = new Date();\r\n        const isFriday = now.getDay() === 5;\r\n\r\n        // For merged Route E, use mergedTimes which has variant info\r\n        if (route?.name === 'Route J') {\r\n            route.services.forEach(service => {\r\n                const trip = service.trips.find(t => t.headsign === currentTrip?.headsign);\r\n                if (trip && trip.times) {\r\n                    trip.times.forEach(t => {\r\n                        const [h, m] = t.split(':').map(Number);\r\n                        const totalMins = h * 60 + m;\r\n                        if (isFriday && totalMins >= 760 && totalMins < 840) return;\r\n\r\n                        // Check if time already exists to avoid duplicates (though rare for distinct services)\r\n                        const exists = groups.morning.concat(groups.afternoon, groups.evening)\r\n                            .some(existing => existing.time === t);\r\n\r\n                        const label = service.service_id === 'TUESDAY' ? 'Tuesday Only' : 'Weekday';\r\n\r\n                        const timeEntry = {\r\n                            time: t,\r\n                            variant: service.service_id,\r\n                            variantLabel: label\r\n                        };\r\n\r\n                        if (!exists) {\r\n                            if (h < 12) groups.morning.push(timeEntry);\r\n                            else if (h < 18) groups.afternoon.push(timeEntry);\r\n                            else groups.evening.push(timeEntry);\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n\r\n            // Sort groups\r\n            ['morning', 'afternoon', 'evening'].forEach(key => {\r\n                groups[key].sort((a, b) => {\r\n                    const [h1, m1] = a.time.split(':').map(Number);\r\n                    const [h2, m2] = b.time.split(':').map(Number);\r\n                    return (h1 * 60 + m1) - (h2 * 60 + m2);\r\n                });\r\n            });\r\n\r\n        } else if (isMergedRouteE && currentTrip?.mergedTimes) {\r\n            currentTrip.mergedTimes.forEach(entry => {\r\n                const [h, m] = entry.time.split(':').map(Number);\r\n                const totalMins = h * 60 + m;\r\n                if (isFriday && totalMins >= 760 && totalMins < 840) return;\r\n\r\n                const timeEntry = {\r\n                    time: entry.time,\r\n                    variant: entry.variant,\r\n                    variantLabel: entry.variantLabel,\r\n                    stops_sequence: entry.stops_sequence,\r\n                    arrival_offsets: entry.arrival_offsets\r\n                };\r\n                if (h < 12) groups.morning.push(timeEntry);\r\n                else if (h < 18) groups.afternoon.push(timeEntry);\r\n                else groups.evening.push(timeEntry);\r\n            });\r\n        } else if (!currentTrip || !currentTrip.times) {\r\n            return groups;\r\n        } else {\r\n            // Standard route - no variant labels\r\n            const uniqueSortedTimes = [...new Set(currentTrip.times)].sort();\r\n            uniqueSortedTimes.forEach(t => {\r\n                const [h, m] = t.split(':').map(Number);\r\n                const totalMins = h * 60 + m;\r\n                if (isFriday && totalMins >= 760 && totalMins < 840) return;\r\n\r\n                const timeEntry = { time: t, variant: null, variantLabel: null };\r\n                if (h < 12) groups.morning.push(timeEntry);\r\n                else if (h < 18) groups.afternoon.push(timeEntry);\r\n                else groups.evening.push(timeEntry);\r\n            });\r\n        }\r\n\r\n        return groups;\r\n    }, [currentTrip, isMergedRouteE, route]);\r\n\r\n    // Active Status Logic\r\n    const routeStatus = useMemo(() => {\r\n        if (!currentTrip) return { status: 'Inactive', color: 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300' };\r\n\r\n        const now = new Date();\r\n        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\r\n        const currentDay = days[now.getDay()];\r\n\r\n        const service = route?.services?.[serviceIdx];\r\n        const runsToday = service?.days?.includes(currentDay);\r\n\r\n        if (!runsToday) {\r\n            return { status: 'Inactive (No Service Today)', color: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200' };\r\n        }\r\n\r\n        const currentHours = now.getHours();\r\n        const currentMinutes = now.getMinutes();\r\n        const currentTotalMins = currentHours * 60 + currentMinutes;\r\n\r\n        if (currentDay === 'friday' && currentTotalMins >= 760 && currentTotalMins < 840) {\r\n            return { status: 'Friday Prayer Break', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200' };\r\n        }\r\n\r\n        let timesToCheck = currentTrip.times;\r\n\r\n        // For Route J (or merged Route E), use the merged times from groupedTimes to calculate status\r\n        if ((route?.name === 'Route J' || isMergedRouteE) && groupedTimes) {\r\n            const allMergedTimes = [...groupedTimes.morning, ...groupedTimes.afternoon, ...groupedTimes.evening]\r\n                .map(t => typeof t === 'string' ? t : t.time);\r\n            if (allMergedTimes.length > 0) {\r\n                timesToCheck = allMergedTimes;\r\n            }\r\n        }\r\n\r\n        if (timesToCheck && timesToCheck.length > 0) {\r\n            const times = timesToCheck.map(t => {\r\n                const [h, m] = t.split(':').map(Number);\r\n                return h * 60 + m;\r\n            }).sort((a, b) => a - b);\r\n\r\n            const firstBus = times[0];\r\n            const currentTimeStr = `${String(currentHours).padStart(2, '0')}:${String(currentMinutes).padStart(2, '0')}`;\r\n            const hasRemainingTrips = timesToCheck.some(time => time > currentTimeStr);\r\n\r\n            if (currentTotalMins < firstBus) {\r\n                return { status: 'Starting Soon', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200' };\r\n            }\r\n\r\n            if (!hasRemainingTrips) {\r\n                return { status: 'Service Ended', color: 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300' };\r\n            }\r\n        }\r\n\r\n        return { status: 'Active', color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-200' };\r\n    }, [currentTrip, route, serviceIdx, groupedTimes, isMergedRouteE]);\r\n\r\n    // Schedule items\r\n    const scheduleItems = useMemo(() => {\r\n        if (!currentTrip || !currentTrip.times || currentTrip.times.length === 0) return [];\r\n\r\n        let startTimeStr = selectedTimeStr;\r\n\r\n        if (!startTimeStr) {\r\n            const now = new Date();\r\n            const currentTotalMins = now.getHours() * 60 + now.getMinutes();\r\n\r\n            // Extract time strings from time entries (which may be objects or strings)\r\n            const allValidTimes = [...groupedTimes.morning, ...groupedTimes.afternoon, ...groupedTimes.evening]\r\n                .map(entry => typeof entry === 'string' ? entry : entry.time)\r\n                .sort();\r\n            if (allValidTimes.length === 0) return [];\r\n\r\n            startTimeStr = allValidTimes[0];\r\n            for (const t of allValidTimes) {\r\n                const [h, m] = t.split(':').map(Number);\r\n                if (h * 60 + m > currentTotalMins) {\r\n                    startTimeStr = t;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        const [startH, startM] = startTimeStr.split(':').map(Number);\r\n\r\n        return stopSequence.map((stopId, index) => {\r\n            const stop = stops?.find(s => s.id === stopId) || { id: stopId, name: stopId };\r\n            let calculatedTime = \"\";\r\n\r\n            if (currentTrip.arrival_offsets && currentTrip.arrival_offsets[index] !== undefined) {\r\n                const offsetMins = currentTrip.arrival_offsets[index];\r\n                const totalMins = startH * 60 + startM + offsetMins;\r\n                const h = Math.floor(totalMins / 60) % 24;\r\n                const m = totalMins % 60;\r\n                calculatedTime = `${h}:${m.toString().padStart(2, '0')}`;\r\n            } else {\r\n                const totalMins = startH * 60 + startM + (index * 3);\r\n                const h = Math.floor(totalMins / 60) % 24;\r\n                const m = totalMins % 60;\r\n                calculatedTime = `${h}:${m.toString().padStart(2, '0')}`;\r\n            }\r\n\r\n            return {\r\n                ...stop,\r\n                calculatedTime,\r\n                offsetMins: currentTrip.arrival_offsets ? currentTrip.arrival_offsets[index] : index * 3\r\n            };\r\n        });\r\n    }, [currentTrip, stopSequence, stops, selectedTimeStr, groupedTimes]);\r\n\r\n    // 4. Effects\r\n\r\n    // Reset selection when direction changes\r\n    useEffect(() => {\r\n        setSelectedTimeStr(null);\r\n        setOpenSection(null);\r\n        // Reset variant when direction changes\r\n        if (isMergedRouteE) {\r\n            setSelectedVariant(null);\r\n        }\r\n    }, [currentTrip, isMergedRouteE]);\r\n\r\n    // For merged Route E: Set default variant on initial load\r\n    useEffect(() => {\r\n        if (isMergedRouteE && !selectedVariant && currentTrip?.mergedTimes?.length > 0) {\r\n            // Find the next upcoming departure's variant\r\n            const now = new Date();\r\n            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;\r\n\r\n            // Find next upcoming time\r\n            const nextDeparture = currentTrip.mergedTimes.find(entry => entry.time >= currentTimeStr);\r\n            if (nextDeparture) {\r\n                setSelectedVariant(nextDeparture.variant);\r\n            } else if (currentTrip.mergedTimes[0]) {\r\n                // If no upcoming, use first variant\r\n                setSelectedVariant(currentTrip.mergedTimes[0].variant);\r\n            }\r\n        }\r\n    }, [isMergedRouteE, selectedVariant, currentTrip]);\r\n\r\n    // For merged Route E: Update geometry when a variant is selected\r\n    useEffect(() => {\r\n        if (isMergedRouteE && selectedVariant && currentTrip && onDirectionSelect) {\r\n            // Use the variant's route name for geometry lookup (e.g., \"Route E(JA)\")\r\n            onDirectionSelect(selectedVariant, currentTrip.headsign);\r\n        }\r\n    }, [selectedVariant, currentTrip, isMergedRouteE, onDirectionSelect]);\r\n\r\n    // 5. Handlers\r\n    const handleTouchStart = (e) => {\r\n        setStartY(e.touches[0].clientY);\r\n        setIsDragging(true);\r\n    };\r\n\r\n    const handleTouchMove = (e) => {\r\n        if (!isDragging) return;\r\n        const y = e.touches[0].clientY;\r\n        setCurrentY(y);\r\n\r\n        // Dynamic update of schedule view while dragging\r\n        if (startY !== null) {\r\n            const diff = startY - y;\r\n            // If pulling up significantly and schedule is hidden, show it\r\n            if (diff > 60 && !showSchedule) {\r\n                setShowSchedule(true);\r\n            }\r\n            // If pulling down significantly and schedule is shown, hide it\r\n            if (diff < -60 && showSchedule && !isExpanded) {\r\n                setShowSchedule(false);\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleTouchEnd = () => {\r\n        setIsDragging(false);\r\n        if (startY !== null && currentY !== null) {\r\n            const diff = startY - currentY;\r\n            if (Math.abs(diff) > 50) { // Threshold\r\n                if (diff > 0) {\r\n                    setIsExpanded(true); // Swipe Up\r\n                    setShowSchedule(true);\r\n                } else {\r\n                    setIsExpanded(false); // Swipe Down\r\n                    setShowSchedule(false);\r\n                }\r\n            }\r\n        }\r\n        setStartY(null);\r\n        setCurrentY(null);\r\n    };\r\n\r\n    const handleDirectionChange = (idx) => {\r\n        setSelectedDirection(idx);\r\n        setSelectedVariant(null); // Reset variant when direction changes\r\n        if (onDirectionSelect && trips[idx]) {\r\n            onDirectionSelect(routeName, trips[idx].headsign);\r\n        }\r\n    };\r\n\r\n    const getSheetHeight = () => {\r\n        const screenH = window.innerHeight;\r\n        const minHeight = 230;\r\n        const maxHeight = screenH - 100;\r\n\r\n        if (isDragging && startY !== null && currentY !== null) {\r\n            const baseH = isExpanded ? maxHeight : minHeight;\r\n            const diff = startY - currentY;\r\n            let newH = baseH + diff;\r\n            if (newH < minHeight) newH = minHeight;\r\n            if (newH > maxHeight) newH = maxHeight;\r\n            return `${newH}px`;\r\n        }\r\n        return isExpanded ? `${maxHeight}px` : `${minHeight}px`;\r\n    };\r\n\r\n    const toggleSection = (section) => {\r\n        setOpenSection(openSection === section ? null : section);\r\n    };\r\n\r\n    const renderAccordion = (title, times, sectionKey) => {\r\n        const isOpen = openSection === sectionKey;\r\n        if (times.length === 0) return null;\r\n\r\n        return (\r\n            <div className=\"border-b border-gray-800 last:border-0\">\r\n                <button\r\n                    onClick={() => toggleSection(sectionKey)}\r\n                    className=\"flex w-full items-center justify-between py-3 px-5 hover:bg-gray-50 dark:hover:bg-[#232e3a] transition-colors\"\r\n                >\r\n                    <span className=\"font-bold text-sm text-white flex items-center gap-2\">\r\n                        {sectionKey === 'morning' && <span className=\"material-symbols-outlined text-orange-400 text-[18px]\">wb_sunny</span>}\r\n                        {sectionKey === 'afternoon' && <span className=\"material-symbols-outlined text-yellow-500 text-[18px]\">light_mode</span>}\r\n                        {sectionKey === 'evening' && <span className=\"material-symbols-outlined text-indigo-400 text-[18px]\">bedtime</span>}\r\n                        {title}\r\n                        <span className=\"ml-2 px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-[10px] text-gray-500 font-medium\">\r\n                            {times.length}\r\n                        </span>\r\n                    </span>\r\n                    <span className={`material-symbols-outlined text-gray-400 text-[20px] transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}>\r\n                        expand_more\r\n                    </span>\r\n                </button>\r\n\r\n                <div className={`overflow-hidden transition-[max-height] duration-300 ease-in-out ${isOpen ? 'max-h-96' : 'max-h-0'}`}>\r\n                    <div className=\"grid grid-cols-3 gap-2 px-5 pb-4 pt-1\">\r\n                        {times.map((entry, idx) => {\r\n                            const timeStr = typeof entry === 'string' ? entry : entry.time;\r\n                            const variantLabel = typeof entry === 'object' ? entry.variantLabel : null;\r\n                            const variantName = typeof entry === 'object' ? entry.variant : null;\r\n                            const isSelected = selectedTimeStr === timeStr && selectedVariant === variantName;\r\n                            const isDefault = scheduleItems[0]?.calculatedTime === timeStr && !selectedTimeStr;\r\n\r\n                            return (\r\n                                <button\r\n                                    key={`${timeStr}-${variantLabel || ''}-${idx}`}\r\n                                    onClick={() => {\r\n                                        setSelectedTimeStr(timeStr);\r\n                                        if (variantName) setSelectedVariant(variantName);\r\n                                    }}\r\n                                    className={`px-2 py-1.5 rounded-lg text-xs font-bold transition-all flex flex-col items-center gap-0.5 ${isSelected\r\n                                        ? 'bg-primary text-white shadow-md'\r\n                                        : isDefault\r\n                                            ? 'bg-blue-100 dark:bg-blue-900/30 text-primary dark:text-blue-300 border border-blue-200 dark:border-blue-800'\r\n                                            : 'bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'\r\n                                        }`}\r\n                                >\r\n                                    <span>{timeStr}</span>\r\n                                    {variantLabel && (\r\n                                        <span className={`text-[9px] font-medium ${isSelected ? 'text-blue-100' : 'text-gray-400'}`}>\r\n                                            {variantLabel === 'Tuesday Only' || variantLabel === 'Weekday' ? variantLabel : `via ${variantLabel}`}\r\n                                        </span>\r\n                                    )}\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-[#101922] font-display text-white antialiased overflow-hidden flex flex-col h-[100dvh] w-full max-w-md mx-auto\">\r\n            {/* Fixed Header */}\r\n            <header className=\"flex items-center bg-white dark:bg-[#1a2632] p-4 pb-2 justify-between shrink-0 shadow-sm z-20\">\r\n                <button\r\n                    onClick={onBack}\r\n                    className=\"text-white flex size-12 shrink-0 items-center justify-center rounded-full hover:bg-gray-800 transition-colors\"\r\n                >\r\n                    <span className=\"material-symbols-outlined\">arrow_back_ios_new</span>\r\n                </button>\r\n                <h2 className=\"text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center\">\r\n                    {routeName}\r\n                </h2>\r\n                <div className=\"flex items-center justify-end gap-1\">\r\n                    <button\r\n                        onClick={() => setShowReportDialog(true)}\r\n                        className=\"flex size-10 cursor-pointer items-center justify-center rounded-full text-white hover:bg-gray-800 transition-colors\"\r\n                        title=\"Report Issue\"\r\n                    >\r\n                        <span className=\"material-symbols-outlined text-orange-400\">report_problem</span>\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            <ReportDialog\r\n                isOpen={showReportDialog}\r\n                onClose={() => setShowReportDialog(false)}\r\n                defaultType=\"route_fix\"\r\n                defaultDetails={`Issue with ${routeName}: `}\r\n            />\r\n\r\n            {/* Content Container */}\r\n            <main className=\"flex-1 relative overflow-hidden h-full\">\r\n                {/* Map Area */}\r\n                <div className=\"absolute inset-0 z-0\">\r\n                    <MapComponent\r\n                        stops={mapStops}\r\n                        routes={routes}\r\n                        selectedRouteStops={stopSequence}\r\n                        routeGeometry={routeGeometry}\r\n                        routeColor={color}\r\n                        userLocation={userLocation}\r\n                        showArrivalInfo={true}\r\n                        selectedRouteName={routeName}\r\n                        selectedHeadsign={currentTrip?.headsign}\r\n                    />\r\n\r\n                    {/* Recenter FAB */}\r\n                    <button\r\n                        className=\"absolute right-4 bg-white dark:bg-[#1a2632] text-primary p-3 rounded-full shadow-lg flex items-center justify-center active:scale-95 transition-all duration-300 ease-out z-[400]\"\r\n                        style={{ bottom: (isExpanded ? 'calc(85vh + 1rem)' : 'calc(230px + 1rem)') }}\r\n                    >\r\n                        <span className=\"material-symbols-outlined\">my_location</span>\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Bottom Sheet */}\r\n                <div\r\n                    className=\"absolute bottom-0 left-0 right-0 bg-white dark:bg-[#1a2632] rounded-t-2xl z-10 flex flex-col shadow-[0_-8px_30px_rgba(0,0,0,0.12)] transition-[height] ease-out will-change-[height]\"\r\n                    style={{\r\n                        height: getSheetHeight(),\r\n                        transitionDuration: isDragging ? '0ms' : '300ms'\r\n                    }}\r\n                >\r\n\r\n                    {/* Drag Handle Area */}\r\n                    <div\r\n                        className=\"relative w-full shrink-0 cursor-grab active:cursor-grabbing touch-none pt-6\"\r\n                        onTouchStart={handleTouchStart}\r\n                        onTouchMove={handleTouchMove}\r\n                        onTouchEnd={handleTouchEnd}\r\n                    >\r\n                        {/* Visual Pull Bar */}\r\n                        <div className=\"absolute top-3 left-1/2 -translate-x-1/2 w-16 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full\"></div>\r\n\r\n                        {/* Direction Selector - More Compact */}\r\n                        {trips.length > 1 && (\r\n                            <div className=\"px-5 pb-2\">\r\n                                <div className=\"flex h-9 w-full items-center justify-center rounded-lg bg-[#f0f2f4] dark:bg-[#1a2633] p-1\">\r\n                                    {trips.map((trip, idx) => (\r\n                                        <label\r\n                                            key={idx}\r\n                                            className={`flex cursor-pointer h-full flex-1 items-center justify-center overflow-hidden rounded-md text-sm font-bold transition-all ${selectedDirection === idx\r\n                                                ? 'bg-white dark:bg-[#2a3847] shadow-sm text-primary dark:text-blue-400'\r\n                                                : 'text-[#617589] dark:text-gray-400'\r\n                                                }`}\r\n                                            onClick={(e) => {\r\n                                                e.stopPropagation();\r\n                                                handleDirectionChange(idx);\r\n                                            }}\r\n                                        >\r\n                                            <span className=\"truncate px-2\">{trip.headsign}</span>\r\n                                        </label>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Section Header - More Compact */}\r\n                        <div className=\"px-5 pb-2 pt-0 border-b border-gray-800 shrink-0\">\r\n                            <div className=\"flex flex-col\">\r\n                                <div className=\"flex justify-between items-center mb-0.5\">\r\n                                    <p className=\"text-gray-500 dark:text-gray-400 text-[11px] font-semibold uppercase tracking-wide\">\r\n                                        {selectedTimeStr ? 'Selected Trip' : 'Next Bus'}\r\n                                    </p>\r\n                                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium ${selectedTimeStr ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200' : routeStatus.color}`}>\r\n                                        {selectedTimeStr ? 'Viewing Plan' : routeStatus.status}\r\n                                    </span>\r\n                                </div>\r\n\r\n                                <div className=\"flex items-baseline gap-2 mb-1.5\">\r\n                                    <h3 className=\"text-white text-2xl font-bold leading-none\">\r\n                                        {scheduleItems[0]?.calculatedTime || '--:--'}\r\n                                    </h3>\r\n                                    <p className=\"text-gray-500 dark:text-gray-400 text-xs font-medium\">\r\n                                        Departing • {scheduleItems.length} Stops\r\n                                    </p>\r\n                                </div>\r\n\r\n                                {/* Schedule Toggle Button - Compact */}\r\n                                <button\r\n                                    onClick={() => {\r\n                                        const nextShow = !showSchedule;\r\n                                        setShowSchedule(nextShow);\r\n                                        setIsExpanded(nextShow); // Also minimize/maximize the panel\r\n                                    }}\r\n                                    className={`flex w-full items-center justify-center gap-2 rounded-xl py-2.5 text-xs font-bold transition-all active:scale-[0.98] ${showSchedule\r\n                                        ? 'bg-[#f0f2f4] dark:bg-[#232e3a] text-primary dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-[#2a3847] ring-1 ring-inset ring-gray-200 dark:ring-gray-700'\r\n                                        : 'bg-blue-600 text-white shadow-lg shadow-blue-600/20'\r\n                                        }`}\r\n                                >\r\n                                    <span className=\"material-symbols-outlined text-[18px]\">\r\n                                        {showSchedule ? 'expand_less' : 'calendar_clock'}\r\n                                    </span>\r\n                                    {showSchedule ? 'Hide Full Schedule' : 'View Full Schedule'}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Scrollable Content - Schedule + Stops together */}\r\n                    <div className=\"flex-1 overflow-y-auto pb-20\">\r\n                        {/* Schedule Accordions - scrolls with stops */}\r\n                        {/* Keeping it always mounted but hidden for performance */}\r\n                        <div className={`flex-col bg-white dark:bg-[#1a2632] border-b border-gray-800 animate-in fade-in slide-in-from-top-1 duration-200 ${showSchedule ? 'flex' : 'hidden'}`}>\r\n                            {renderAccordion(\"Morning\", groupedTimes.morning, 'morning')}\r\n                            {renderAccordion(\"Afternoon\", groupedTimes.afternoon, 'afternoon')}\r\n                            {renderAccordion(\"Evening\", groupedTimes.evening, 'evening')}\r\n                        </div>\r\n\r\n                        {/* Timeline List */}\r\n                        <div className=\"px-5 pt-4\">\r\n                            {scheduleItems.map((item, idx) => (\r\n                                <div key={`${item.id}-${idx}`} className=\"grid grid-cols-[32px_1fr] gap-x-3\">\r\n                                    <div className=\"flex flex-col items-center\">\r\n                                        {idx > 0 && <div className=\"w-0.5 h-2\" style={{ backgroundColor: `${color}30` }}></div>}\r\n                                        {idx === 0 ? (\r\n                                            <div\r\n                                                className=\"relative z-10 flex items-center justify-center size-8 rounded-full shadow-md\"\r\n                                                style={{ backgroundColor: color }}\r\n                                            >\r\n                                                <span className=\"material-symbols-outlined text-white text-[18px]\">directions_bus</span>\r\n                                            </div>\r\n                                        ) : (\r\n                                            <div\r\n                                                className=\"size-4 rounded-full border-[3px] bg-white dark:bg-[#1a2632]\"\r\n                                                style={{ borderColor: item.offsetMins < 10 ? color : '#d1d5db' }}\r\n                                            ></div>\r\n                                        )}\r\n                                        {idx < scheduleItems.length - 1 && (\r\n                                            <div\r\n                                                className=\"w-0.5 h-full grow min-h-[2rem]\"\r\n                                                style={{ backgroundColor: item.offsetMins < 10 ? `${color}30` : '#e5e7eb' }}\r\n                                            ></div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className={`flex flex-1 flex-col pb-6 ${idx === 0 ? 'pt-1' : ''}`}>\r\n                                        <div className=\"flex justify-between items-center h-full\">\r\n                                            <div>\r\n                                                <p className={`text-base leading-tight ${idx === 0\r\n                                                    ? 'font-bold'\r\n                                                    : item.offsetMins < 10\r\n                                                        ? 'font-medium text-white'\r\n                                                        : 'font-medium text-gray-500 dark:text-gray-400'\r\n                                                    }`} style={idx === 0 ? { color } : {}}>\r\n                                                    {item.name}\r\n                                                </p>\r\n                                                {idx === 0 && <p className=\"text-gray-500 dark:text-gray-400 text-sm mt-0.5\">Departing</p>}\r\n                                            </div>\r\n                                            <div className=\"flex flex-col items-end\">\r\n                                                <span className={`text-sm font-bold ${idx === 0 ? 'text-primary' : 'text-white'}`}>\r\n                                                    {item.calculatedTime}\r\n                                                </span>\r\n                                                {idx > 0 && (\r\n                                                    <span className=\"text-[10px] text-gray-400 font-medium\">\r\n                                                        +{item.offsetMins} min\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </main>\r\n\r\n            {/* Bottom Navigation Bar */}\r\n            <BottomNavigation activeTab={activeTab} onTabChange={onTabChange} />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MobileRouteDetailPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileRoutesPage.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'fetchNextBus' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"fetchNextBus"},"fix":{"range":[152,202],"text":""},"desc":"Remove unused variable 'fetchNextBus'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'idx' is defined but never used.","line":320,"column":125,"nodeType":"Identifier","messageId":"unusedVar","endLine":320,"endColumn":128,"suggestions":[{"messageId":"removeVar","data":{"varName":"idx"},"fix":{"range":[19322,19327],"text":""},"desc":"Remove unused variable 'idx'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from 'react';\r\nimport BottomNavigation from './BottomNavigation';\r\nimport ReportDialog from '../ReportDialog';\r\nimport { fetchNextBus } from '../../services/api';\r\nimport { getRouteColor } from '../../constants';\r\n\r\nconst MobileRoutesPage = ({ activeTab, onTabChange, routes, onSelectRoute }) => {\r\n    const [selectedService, setSelectedService] = useState('WEEKDAY');\r\n    const [nextBusData, setNextBusData] = useState({});\r\n    const [showReportDialog, setShowReportDialog] = useState(false);\r\n\r\n    // Use local calculation instead of API polling\r\n    useEffect(() => {\r\n        if (!routes || routes.length === 0) return;\r\n\r\n        // Function to update times locally\r\n        const updateTimes = () => {\r\n            const now = new Date();\r\n            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;\r\n\r\n            // Calculate for all routes at once locally\r\n            // No API call needed!\r\n            import('../../utils/scheduleUtils').then(({ calculateAllNextBuses }) => {\r\n                const newData = calculateAllNextBuses(routes, timeStr);\r\n                setNextBusData(newData);\r\n            });\r\n        };\r\n\r\n        updateTimes();\r\n\r\n        // Update every second for \"Real-Time\" feel (countdown), or every minute if we just show minutes\r\n        // Since the UI shows \"X min\", updating every 10-30s is enough, but 1s is fine for local calc.\r\n        const interval = setInterval(updateTimes, 30000); // Update every 30s\r\n        return () => clearInterval(interval);\r\n    }, [routes]);\r\n\r\n    // Merge weekday Route E variants into a single \"Route E\" entry\r\n    const displayRoutes = useMemo(() => {\r\n        if (!routes || routes.length === 0) return [];\r\n\r\n        let result = [];\r\n\r\n        // For WEEKEND, just rename E(N24) to \"Route E\"\r\n        if (selectedService === 'WEEKEND') {\r\n            result = routes.map(r => {\r\n                if (r.name === 'Route E(N24)') {\r\n                    return { ...r, displayName: 'Route E' };\r\n                }\r\n                return { ...r, displayName: r.name };\r\n            });\r\n        } else {\r\n            // For WEEKDAY, merge E(JA), E(CP), E(N24) into single \"Route E\"\r\n            const routeEVariants = routes.filter(r =>\r\n                r.name.startsWith('Route E(') &&\r\n                r.services?.some(s => s.service_id === 'WEEKDAY')\r\n            );\r\n            const otherRoutes = routes.filter(r => !r.name.startsWith('Route E('));\r\n\r\n            if (routeEVariants.length > 0) {\r\n                // Create merged Route E with all variants' data\r\n                const mergedRouteE = {\r\n                    name: 'Route E',\r\n                    displayName: 'Route E',\r\n                    isMerged: true,\r\n                    variants: routeEVariants,\r\n                    services: [{\r\n                        service_id: 'WEEKDAY',\r\n                        days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],\r\n                        trips: routeEVariants.flatMap(variant => {\r\n                            const weekdayService = variant.services?.find(s => s.service_id === 'WEEKDAY');\r\n                            return (weekdayService?.trips || []).map(trip => ({\r\n                                ...trip,\r\n                                variantName: variant.name,\r\n                                variantLabel: variant.name.match(/\\(([^)]+)\\)/)?.[1] || ''\r\n                            }));\r\n                        })\r\n                    }]\r\n                };\r\n                result = [...otherRoutes.map(r => ({ ...r, displayName: r.name })), mergedRouteE];\r\n            } else {\r\n                result = routes.map(r => ({ ...r, displayName: r.name }));\r\n            }\r\n        }\r\n\r\n        // Sort routes alphabetically by displayName\r\n        return result.sort((a, b) => a.displayName.localeCompare(b.displayName));\r\n    }, [routes, selectedService]);\r\n\r\n    // Get next bus time across all E variants for merged Route E\r\n    const getNextBusForMergedE = useMemo(() => {\r\n        if (selectedService !== 'WEEKDAY') return null;\r\n\r\n        const eVariantNames = ['Route E(JA)', 'Route E(CP)', 'Route E(N24)'];\r\n        let earliest = null;\r\n        let earliestVariant = null;\r\n\r\n        for (const name of eVariantNames) {\r\n            const data = nextBusData[name];\r\n            if (data?.nextBus?.time) {\r\n                if (!earliest || data.nextBus.time < earliest) {\r\n                    earliest = data.nextBus.time;\r\n                    earliestVariant = name.match(/\\(([^)]+)\\)/)?.[1] || '';\r\n                }\r\n            }\r\n        }\r\n\r\n        return earliest ? { time: earliest, variant: earliestVariant } : null;\r\n    }, [nextBusData, selectedService]);\r\n\r\n\r\n    return (\r\n        <div className=\"relative flex h-full min-h-screen w-full flex-col overflow-x-hidden max-w-md mx-auto bg-[#101922] shadow-xl\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center px-4 py-3 sticky top-0 bg-[#101922] z-20 border-b border-gray-800\">\r\n                <div className=\"w-[84px]\"></div> {/* Left spacer matches right group */}\r\n                <div className=\"flex-1 flex flex-col items-center\">\r\n                    <h2 className=\"text-lg font-bold text-white leading-tight tracking-tight\">All Routes</h2>\r\n                </div>\r\n                <div className=\"flex items-center justify-end gap-1 w-[84px]\">\r\n                    <button\r\n                        onClick={() => setShowReportDialog(true)}\r\n                        className=\"flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-gray-800 cursor-pointer text-white transition-colors\"\r\n                        title=\"Report Issue\"\r\n                    >\r\n                        <span className=\"material-symbols-outlined text-orange-400\">report_problem</span>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => onTabChange('info')}\r\n                        className=\"flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-gray-800 cursor-pointer text-white transition-colors\"\r\n                    >\r\n                        <span className=\"material-symbols-outlined\">info</span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <ReportDialog\r\n                isOpen={showReportDialog}\r\n                onClose={() => setShowReportDialog(false)}\r\n            />\r\n\r\n            {/* Service Type Tabs */}\r\n            <div className=\"px-4 py-2 bg-[#101922]\">\r\n                <div className=\"flex h-10 w-full items-center justify-center rounded-lg bg-[#f0f2f4] dark:bg-[#1a2633] p-1\">\r\n                    <label\r\n                        className={`flex cursor-pointer h-full flex-1 items-center justify-center overflow-hidden rounded-md text-sm font-bold transition-all ${selectedService === 'WEEKDAY'\r\n                            ? 'bg-white dark:bg-[#2a3847] shadow-sm text-primary dark:text-blue-400'\r\n                            : 'text-[#617589] dark:text-gray-400 hover:text-[#111418] dark:hover:text-gray-200'\r\n                            }`}\r\n                        onClick={() => setSelectedService('WEEKDAY')}\r\n                    >\r\n                        <span className=\"truncate\">Weekday</span>\r\n                    </label>\r\n                    <label\r\n                        className={`flex cursor-pointer h-full flex-1 items-center justify-center overflow-hidden rounded-md text-sm font-bold transition-all ${selectedService === 'WEEKEND'\r\n                            ? 'bg-white dark:bg-[#2a3847] shadow-sm text-primary dark:text-blue-400'\r\n                            : 'text-[#617589] dark:text-gray-400 hover:text-[#111418] dark:hover:text-gray-200'\r\n                            }`}\r\n                        onClick={() => setSelectedService('WEEKEND')}\r\n                    >\r\n                        <span className=\"truncate\">Weekend</span>\r\n                    </label>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Routes List */}\r\n            <div className=\"flex-1 overflow-y-auto bg-[#101922] pb-24\">\r\n                <div className=\"px-4 py-4 space-y-3\">\r\n                    {displayRoutes && displayRoutes.length > 0 ? (\r\n                        displayRoutes\r\n                            .filter(route => route.services?.some(s => s.service_id === selectedService))\r\n                            .map((route) => {\r\n                                const color = getRouteColor(route.displayName || route.name);\r\n                                const activeService = route.services?.find(s => s.service_id === selectedService);\r\n\r\n                                // For merged Route E, use the combined next bus data\r\n                                let nextTime, headsign;\r\n                                if (route.isMerged && route.name === 'Route E') {\r\n                                    nextTime = getNextBusForMergedE?.time;\r\n                                    headsign = getNextBusForMergedE ? `via ${getNextBusForMergedE.variant}` : 'View Schedule';\r\n                                } else {\r\n                                    const routeInfo = nextBusData[route.name];\r\n                                    nextTime = routeInfo?.nextBus?.time;\r\n                                    headsign = routeInfo?.nextBus?.headsign || activeService?.trips?.[0]?.headsign || 'View Schedule';\r\n                                }\r\n\r\n                                // Calculate Status\r\n                                const now = new Date();\r\n                                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\r\n                                const currentDay = days[now.getDay()];\r\n                                const isServiceDay = activeService?.days?.includes(currentDay);\r\n\r\n                                let statusText = 'Inactive';\r\n                                let statusColor = 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300'; // Default Inactive\r\n\r\n                                if (isServiceDay) {\r\n                                    const currentHours = now.getHours();\r\n                                    const currentMinutes = now.getMinutes();\r\n                                    const currentTotalMins = currentHours * 60 + currentMinutes;\r\n                                    const currentTimeStr = `${String(currentHours).padStart(2, '0')}:${String(currentMinutes).padStart(2, '0')}`;\r\n                                    const isFridayPrayer = currentDay === 'friday' && currentTotalMins >= 760 && currentTotalMins < 840;\r\n\r\n                                    // Find the earliest and latest bus times for this service\r\n                                    let earliestTime = '23:59';\r\n                                    let latestTime = '00:00';\r\n\r\n                                    activeService?.trips?.forEach(trip => {\r\n                                        trip.times?.forEach(time => {\r\n                                            if (time && time < earliestTime) earliestTime = time;\r\n                                            if (time && time > latestTime) latestTime = time;\r\n                                        });\r\n                                    });\r\n\r\n                                    // Check if current time is within service hours\r\n                                    const isBeforeServiceStart = currentTimeStr < earliestTime;\r\n                                    const isAfterServiceEnd = currentTimeStr > latestTime;\r\n\r\n                                    // Check how many headsigns have remaining trips\r\n                                    let activeHeadsigns = 0;\r\n                                    let totalHeadsigns = activeService?.trips?.length || 0;\r\n\r\n                                    activeService?.trips?.forEach(trip => {\r\n                                        const hasRemainingTrips = trip.times?.some(time => time > currentTimeStr);\r\n                                        if (hasRemainingTrips) activeHeadsigns++;\r\n                                    });\r\n\r\n                                    if (isFridayPrayer) {\r\n                                        statusText = 'Prayer Break';\r\n                                        statusColor = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200';\r\n                                    } else if (isBeforeServiceStart) {\r\n                                        // Before first bus - check if starting within an hour\r\n                                        const earlyParts = earliestTime.split(':').map(Number);\r\n                                        const earlyTotalMins = earlyParts[0] * 60 + earlyParts[1];\r\n                                        const minsUntilStart = earlyTotalMins - currentTotalMins;\r\n\r\n                                        if (minsUntilStart <= 60 && minsUntilStart > 0) {\r\n                                            statusText = 'Starting Soon';\r\n                                            statusColor = 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200';\r\n                                        } else {\r\n                                            statusText = 'Inactive';\r\n                                            statusColor = 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400';\r\n                                        }\r\n                                    } else if (isAfterServiceEnd) {\r\n                                        statusText = 'Service Ended';\r\n                                        statusColor = 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400';\r\n                                    } else if (activeHeadsigns === totalHeadsigns && totalHeadsigns > 0) {\r\n                                        // All headsigns have remaining trips\r\n                                        statusText = 'Active';\r\n                                        statusColor = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';\r\n                                    } else if (activeHeadsigns > 0) {\r\n                                        // Some headsigns have remaining trips\r\n                                        statusText = 'Limited';\r\n                                        statusColor = 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-200';\r\n                                    } else {\r\n                                        // No remaining trips\r\n                                        statusText = 'Service Ended';\r\n                                        statusColor = 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400';\r\n                                    }\r\n                                } else {\r\n                                    statusText = 'Not Today';\r\n                                    statusColor = 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200';\r\n                                }\r\n\r\n                                // Use displayName from merged routes logic\r\n                                const displayName = route.displayName || route.name;\r\n\r\n                                return (\r\n                                    <div\r\n                                        key={route.name}\r\n                                        onClick={() => onSelectRoute && onSelectRoute(route, selectedService)}\r\n                                        className=\"bg-[#1a2633] rounded-xl shadow-sm p-4 border border-gray-800 cursor-pointer hover:shadow-md transition-shadow\"\r\n                                    >\r\n                                        <div className=\"flex items-center gap-4\">\r\n                                            <div\r\n                                                className=\"h-12 w-12 rounded-xl flex items-center justify-center shrink-0\"\r\n                                                style={{ backgroundColor: `${color}20` }}\r\n                                            >\r\n                                                <span\r\n                                                    className=\"material-symbols-outlined text-2xl\"\r\n                                                    style={{ color }}\r\n                                                >\r\n                                                    directions_bus\r\n                                                </span>\r\n                                            </div>\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <div className=\"flex items-center justify-between\">\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        <h3 className=\"text-white text-base font-bold truncate\">\r\n                                                            {displayName}\r\n                                                        </h3>\r\n                                                        <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium ${statusColor}`}>\r\n                                                            {statusText}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                    {nextTime && (\r\n                                                        <span\r\n                                                            className=\"text-xs font-black px-2 py-1 rounded shadow-sm\"\r\n                                                            style={{\r\n                                                                backgroundColor: `${color}15`,\r\n                                                                color: color,\r\n                                                                border: `1px solid ${color}30`\r\n                                                            }}\r\n                                                        >\r\n                                                            {nextTime}\r\n                                                        </span>\r\n                                                    )}\r\n                                                </div>\r\n                                                <p className=\"text-[#617589] dark:text-gray-400 text-sm truncate\">\r\n                                                    {headsign}\r\n                                                </p>\r\n                                            </div>\r\n                                            <span className=\"material-symbols-outlined text-gray-400 dark:text-gray-500\">\r\n                                                chevron_right\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                );\r\n                            })\r\n                    ) : (\r\n                        // Placeholder routes\r\n                        ['Route A', 'Route B', 'Route C', 'Route D', 'Route E', 'Route F', 'Route G', 'Route L'].map((name, idx) => {\r\n                            const color = getRouteColor(name);\r\n                            return (\r\n                                <div\r\n                                    key={name}\r\n                                    onClick={() => onSelectRoute && onSelectRoute({ name, services: [] })}\r\n                                    className=\"bg-[#1a2633] rounded-xl shadow-sm p-4 border border-gray-800 cursor-pointer hover:shadow-md transition-shadow\"\r\n                                >\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div\r\n                                            className=\"h-12 w-12 rounded-xl flex items-center justify-center shrink-0\"\r\n                                            style={{ backgroundColor: `${color}20` }}\r\n                                        >\r\n                                            <span className=\"material-symbols-outlined text-2xl\" style={{ color }}>\r\n                                                directions_bus\r\n                                            </span>\r\n                                        </div>\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <h3 className=\"text-white text-base font-bold truncate\">\r\n                                                    {name}\r\n                                                </h3>\r\n                                                <span className=\"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\">\r\n                                                    Active\r\n                                                </span>\r\n                                            </div>\r\n                                            <p className=\"text-[#617589] dark:text-gray-400 text-sm truncate\">\r\n                                                View Schedule\r\n                                            </p>\r\n                                        </div>\r\n                                        <span className=\"material-symbols-outlined text-gray-400 dark:text-gray-500\">\r\n                                            chevron_right\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Bottom Navigation */}\r\n            <BottomNavigation activeTab={activeTab} onTabChange={onTabChange} />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MobileRoutesPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\components\\mobile\\MobileSearchPage.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'stops' is defined but never used.","line":8,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":77,"suggestions":[{"messageId":"removeVar","data":{"varName":"stops"},"fix":{"range":[284,291],"text":""},"desc":"Remove unused variable 'stops'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  16 |         const savedFavourites = localStorage.getItem(FAVOURITES_KEY);\n  17 |         if (savedFavourites) {\n> 18 |             setFavourites(JSON.parse(savedFavourites));\n     |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |         }\n  20 |         const savedRecent = localStorage.getItem(RECENT_KEY);\n  21 |         if (savedRecent) {","line":18,"column":13,"nodeType":null,"endLine":18,"endColumn":26},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'categories'. Either include it or remove the dependency array.","line":84,"column":8,"nodeType":"ArrayExpression","endLine":84,"endColumn":60,"suggestions":[{"desc":"Update the dependencies array to be: [locations, searchQuery, activeCategory, categories]","fix":{"range":[3585,3637],"text":"[locations, searchQuery, activeCategory, categories]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from 'react';\r\nimport BottomNavigation from './BottomNavigation';\r\n\r\n// localStorage keys\r\nconst FAVOURITES_KEY = 'utmove_favourites';\r\nconst RECENT_KEY = 'utmove_recent';\r\n\r\nconst MobileSearchPage = ({ activeTab, onTabChange, onBack, locations, stops, onSelectLocation, searchType, onPinOnMap }) => {\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [activeCategory, setActiveCategory] = useState(null); // null = show default, or 'food', 'faculty', 'residential', 'favourites'\r\n    const [favourites, setFavourites] = useState([]);\r\n    const [recentLocations, setRecentLocations] = useState([]);\r\n\r\n    // Load favourites and recent from localStorage\r\n    useEffect(() => {\r\n        const savedFavourites = localStorage.getItem(FAVOURITES_KEY);\r\n        if (savedFavourites) {\r\n            setFavourites(JSON.parse(savedFavourites));\r\n        }\r\n        const savedRecent = localStorage.getItem(RECENT_KEY);\r\n        if (savedRecent) {\r\n            setRecentLocations(JSON.parse(savedRecent));\r\n        }\r\n    }, []);\r\n\r\n    // Save to recent when selecting a location\r\n    const handleSelectLocation = (location) => {\r\n        if (location) {\r\n            // Add to recent (max 5, no duplicates)\r\n            const updated = [location, ...recentLocations.filter(l => l.id !== location.id)].slice(0, 5);\r\n            setRecentLocations(updated);\r\n            localStorage.setItem(RECENT_KEY, JSON.stringify(updated));\r\n        }\r\n        onSelectLocation && onSelectLocation(location);\r\n    };\r\n\r\n    // Toggle favourite\r\n    const toggleFavourite = (e, location) => {\r\n        e.stopPropagation();\r\n        const isFav = favourites.some(f => f.id === location.id);\r\n        let updated;\r\n        if (isFav) {\r\n            updated = favourites.filter(f => f.id !== location.id);\r\n        } else {\r\n            updated = [...favourites, location];\r\n        }\r\n        setFavourites(updated);\r\n        localStorage.setItem(FAVOURITES_KEY, JSON.stringify(updated));\r\n    };\r\n\r\n    const isFavourite = (locationId) => favourites.some(f => f.id === locationId);\r\n\r\n    // Category definitions (removed favourites - shown directly on page)\r\n    const categories = [\r\n        { id: 'food', label: 'Food', icon: 'restaurant', color: 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400', filter: 'dining' },\r\n        { id: 'faculty', label: 'Faculty', icon: 'school', color: 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400', filter: 'academic' },\r\n        { id: 'residential', label: 'Kolej', icon: 'apartment', color: 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400', filter: 'residential' },\r\n    ];\r\n\r\n    // Filtered locations based on search or category\r\n    const filteredLocations = useMemo(() => {\r\n        let result = locations || [];\r\n\r\n        // If searching, filter by query\r\n        if (searchQuery) {\r\n            const query = searchQuery.toLowerCase();\r\n            result = result.filter(l =>\r\n                l.name.toLowerCase().includes(query) ||\r\n                (l.keywords && l.keywords.some(k => k.toLowerCase().includes(query)))\r\n            );\r\n            return result.slice(0, 15);\r\n        }\r\n\r\n        // If category selected\r\n        if (activeCategory) {\r\n            const cat = categories.find(c => c.id === activeCategory);\r\n            if (cat && cat.filter) {\r\n                result = result.filter(l => l.category === cat.filter);\r\n            }\r\n            return result.slice(0, 20);\r\n        }\r\n\r\n        return [];\r\n    }, [searchQuery, locations, activeCategory, favourites]);\r\n\r\n    // Get icon for category\r\n    const getCategoryIcon = (category) => {\r\n        switch (category) {\r\n            case 'dining': return 'restaurant';\r\n            case 'academic': return 'school';\r\n            case 'residential': return 'apartment';\r\n            case 'facility': return 'fitness_center';\r\n            default: return 'location_on';\r\n        }\r\n    };\r\n\r\n    const getCategoryColor = (category) => {\r\n        switch (category) {\r\n            case 'dining': return 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400';\r\n            case 'academic': return 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';\r\n            case 'residential': return 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';\r\n            case 'facility': return 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400';\r\n            default: return 'bg-gray-800 text-gray-600 dark:text-gray-400';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-[#101922] font-display text-white h-full min-h-screen flex flex-col overflow-x-hidden w-full transition-colors duration-200\">\r\n            {/* Top App Bar */}\r\n            <header className=\"sticky top-0 z-50 bg-[#101922] border-b border-gray-800 transition-colors duration-200\">\r\n                <div className=\"flex items-center px-4 py-3 justify-between\">\r\n                    <button\r\n                        onClick={onBack}\r\n                        className=\"flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-gray-800 transition-colors\"\r\n                    >\r\n                        <span className=\"material-symbols-outlined text-white\">arrow_back</span>\r\n                    </button>\r\n                    <h2 className=\"text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-10\">\r\n                        {searchType === 'origin' ? 'Select Start Location' : 'Select Destination'}\r\n                    </h2>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Main Content */}\r\n            <main className=\"flex-1 w-full px-4 pb-24 pt-4\">\r\n                {/* Search Bar */}\r\n                <div className=\"mb-5\">\r\n                    <label className=\"flex flex-col h-12 w-full\">\r\n                        <div className=\"flex w-full flex-1 items-stretch rounded-xl h-full shadow-sm border border-gray-800\">\r\n                            <div className=\"flex border-none bg-[#1a2633] items-center justify-center pl-4 rounded-l-xl border-r-0\">\r\n                                <span className=\"material-symbols-outlined text-[#617589] dark:text-gray-400\">search</span>\r\n                            </div>\r\n                            <input\r\n                                className=\"flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl rounded-l-none text-white focus:outline-0 focus:ring-2 focus:ring-primary/20 border-none bg-[#1a2633] focus:border-none h-full placeholder:text-[#617589] dark:placeholder:text-gray-400 px-4 pl-2 text-base font-normal leading-normal\"\r\n                                placeholder=\"Search location...\"\r\n                                type=\"text\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => {\r\n                                    setSearchQuery(e.target.value);\r\n                                    setActiveCategory(null);\r\n                                }}\r\n                                autoFocus\r\n                            />\r\n                            {searchQuery && (\r\n                                <button\r\n                                    onClick={() => setSearchQuery('')}\r\n                                    className=\"flex items-center justify-center pr-4 bg-[#1a2633] rounded-r-xl\"\r\n                                >\r\n                                    <span className=\"material-symbols-outlined text-gray-400 text-xl\">close</span>\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    </label>\r\n                </div>\r\n\r\n                {/* Use Current Location (for origin only) */}\r\n                {searchType === 'origin' && !searchQuery && !activeCategory && (\r\n                    <button\r\n                        onClick={() => handleSelectLocation(null)}\r\n                        className=\"w-full flex items-center gap-4 px-4 py-4 mb-3 bg-[#1a2633] rounded-xl shadow-sm border border-gray-800 hover:bg-gray-800/50 transition-colors group\"\r\n                    >\r\n                        <div className=\"flex items-center justify-center rounded-lg bg-primary/10 text-primary shrink-0 size-10 group-hover:bg-primary group-hover:text-white transition-colors\">\r\n                            <span className=\"material-symbols-outlined\">my_location</span>\r\n                        </div>\r\n                        <div className=\"flex flex-col items-start flex-1 text-left\">\r\n                            <p className=\"text-white text-base font-semibold leading-tight\">Use Current Location</p>\r\n                            <p className=\"text-[#617589] dark:text-gray-400 text-sm mt-0.5\">Your GPS location</p>\r\n                        </div>\r\n                        <span className=\"material-symbols-outlined text-gray-400\">chevron_right</span>\r\n                    </button>\r\n                )}\r\n\r\n                {/* Pin on Map option */}\r\n                {!searchQuery && !activeCategory && (\r\n                    <button\r\n                        onClick={() => onPinOnMap && onPinOnMap(searchType)}\r\n                        className=\"w-full flex items-center gap-4 px-4 py-4 mb-5 bg-[#1a2633] rounded-xl shadow-sm border border-gray-800 hover:bg-gray-800/50 transition-colors group\"\r\n                    >\r\n                        <div className={`flex items-center justify-center rounded-lg shrink-0 size-10 transition-colors ${searchType === 'origin'\r\n                            ? 'bg-blue-500/10 text-blue-500 group-hover:bg-blue-500 group-hover:text-white'\r\n                            : 'bg-red-500/10 text-red-500 group-hover:bg-red-500 group-hover:text-white'\r\n                            }`}>\r\n                            <span className=\"material-symbols-outlined\">push_pin</span>\r\n                        </div>\r\n                        <div className=\"flex flex-col items-start flex-1 text-left\">\r\n                            <p className=\"text-white text-base font-semibold leading-tight\">Pin on Map</p>\r\n                            <p className=\"text-[#617589] dark:text-gray-400 text-sm mt-0.5\">\r\n                                {searchType === 'origin' ? 'Tap map to set start' : 'Tap map to set destination'}\r\n                            </p>\r\n                        </div>\r\n                        <span className=\"material-symbols-outlined text-gray-400\">chevron_right</span>\r\n                    </button>\r\n                )}\r\n\r\n                {/* Category Icons */}\r\n                {!searchQuery && !activeCategory && (\r\n                    <>\r\n                        <h3 className=\"text-sm font-bold text-[#617589] dark:text-gray-400 uppercase tracking-widest px-1 mb-3\">\r\n                            Browse by Category\r\n                        </h3>\r\n                        <div className=\"grid grid-cols-3 gap-3 mb-6\">\r\n                            {categories.map(cat => (\r\n                                <button\r\n                                    key={cat.id}\r\n                                    onClick={() => setActiveCategory(cat.id)}\r\n                                    className=\"flex flex-col items-center gap-2 p-3 bg-[#1a2633] rounded-xl shadow-sm border border-gray-800 hover:ring-2 ring-primary/20 transition-all\"\r\n                                >\r\n                                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${cat.color}`}>\r\n                                        <span className=\"material-symbols-outlined text-2xl\">{cat.icon}</span>\r\n                                    </div>\r\n                                    <span className=\"text-xs font-semibold text-white\">{cat.label}</span>\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    </>\r\n                )}\r\n\r\n                {/* Favourites - Always visible */}\r\n                {!searchQuery && !activeCategory && favourites.length > 0 && (\r\n                    <>\r\n                        <h3 className=\"text-sm font-bold text-[#617589] dark:text-gray-400 uppercase tracking-widest px-1 mb-3 flex items-center gap-2\">\r\n                            <span className=\"material-symbols-outlined text-red-500 text-base\" style={{ fontVariationSettings: \"'FILL' 1\" }}>favorite</span>\r\n                            Favourites\r\n                        </h3>\r\n                        <div className=\"bg-[#1a2633] rounded-xl shadow-sm overflow-hidden mb-6 border border-gray-800\">\r\n                            {favourites.slice(0, 5).map((location, idx) => (\r\n                                <div\r\n                                    key={location.id}\r\n                                    onClick={() => handleSelectLocation(location)}\r\n                                    role=\"button\"\r\n                                    tabIndex={0}\r\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSelectLocation(location)}\r\n                                    className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800/50 transition-colors cursor-pointer ${idx < Math.min(favourites.length, 5) - 1 ? 'border-b border-gray-800' : ''}`}\r\n                                >\r\n                                    <div className={`w-9 h-9 rounded-lg flex items-center justify-center shrink-0 ${getCategoryColor(location.category)}`}>\r\n                                        <span className=\"material-symbols-outlined text-lg\">{getCategoryIcon(location.category)}</span>\r\n                                    </div>\r\n                                    <div className=\"flex-1 text-left truncate\">\r\n                                        <p className=\"text-white text-sm font-medium truncate\">{location.name}</p>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={(e) => toggleFavourite(e, location)}\r\n                                        className=\"p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n                                    >\r\n                                        <span className=\"material-symbols-outlined text-lg text-red-500\" style={{ fontVariationSettings: \"'FILL' 1\" }}>favorite</span>\r\n                                    </button>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </>\r\n                )}\r\n\r\n                {/* Recent Locations */}\r\n                {!searchQuery && !activeCategory && recentLocations.length > 0 && (\r\n                    <>\r\n                        <h3 className=\"text-sm font-bold text-[#617589] dark:text-gray-400 uppercase tracking-widest px-1 mb-3 flex items-center gap-2\">\r\n                            <span className=\"material-symbols-outlined text-gray-400 text-base\">history</span>\r\n                            Recently Viewed\r\n                        </h3>\r\n                        <div className=\"bg-[#1a2633] rounded-xl shadow-sm overflow-hidden mb-6 border border-gray-800\">\r\n                            {recentLocations.map((location, idx) => (\r\n                                <div\r\n                                    key={location.id}\r\n                                    onClick={() => handleSelectLocation(location)}\r\n                                    role=\"button\"\r\n                                    tabIndex={0}\r\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSelectLocation(location)}\r\n                                    className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800/50 transition-colors cursor-pointer ${idx < recentLocations.length - 1 ? 'border-b border-gray-800' : ''}`}\r\n                                >\r\n                                    <div className={`w-9 h-9 rounded-lg flex items-center justify-center shrink-0 ${getCategoryColor(location.category)}`}>\r\n                                        <span className=\"material-symbols-outlined text-lg\">{getCategoryIcon(location.category)}</span>\r\n                                    </div>\r\n                                    <div className=\"flex-1 text-left truncate\">\r\n                                        <p className=\"text-white text-sm font-medium truncate\">{location.name}</p>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={(e) => toggleFavourite(e, location)}\r\n                                        className=\"p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n                                    >\r\n                                        <span className={`material-symbols-outlined text-lg ${isFavourite(location.id) ? 'text-red-500' : 'text-gray-300 dark:text-gray-600'}`}\r\n                                            style={{ fontVariationSettings: isFavourite(location.id) ? \"'FILL' 1\" : \"'FILL' 0\" }}\r\n                                        >favorite</span>\r\n                                    </button>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </>\r\n                )}\r\n\r\n                {/* Category Header with Back */}\r\n                {activeCategory && !searchQuery && (\r\n                    <div className=\"flex items-center gap-2 mb-3\">\r\n                        <button\r\n                            onClick={() => setActiveCategory(null)}\r\n                            className=\"flex items-center justify-center size-8 rounded-full hover:bg-gray-800 transition-colors\"\r\n                        >\r\n                            <span className=\"material-symbols-outlined text-lg text-gray-500\">arrow_back</span>\r\n                        </button>\r\n                        <h3 className=\"text-sm font-bold text-[#617589] dark:text-gray-400 uppercase tracking-widest\">\r\n                            {categories.find(c => c.id === activeCategory)?.label || 'Results'}\r\n                        </h3>\r\n                        <span className=\"text-xs text-gray-400 ml-auto\">{filteredLocations.length} locations</span>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Search Results Header */}\r\n                {searchQuery && (\r\n                    <h3 className=\"text-sm font-bold text-[#617589] dark:text-gray-400 uppercase tracking-widest px-1 mb-3\">\r\n                        Search Results ({filteredLocations.length})\r\n                    </h3>\r\n                )}\r\n\r\n                {/* Locations List */}\r\n                {(searchQuery || activeCategory) && (\r\n                    <div className=\"bg-[#1a2633] rounded-xl shadow-sm overflow-hidden mb-6 border border-gray-800\">\r\n                        {filteredLocations.length === 0 ? (\r\n                            <div className=\"p-8 text-center\">\r\n                                <span className=\"material-symbols-outlined text-4xl text-gray-300 dark:text-gray-600 mb-2\">search_off</span>\r\n                                <p className=\"text-gray-500 dark:text-gray-400\">\r\n                                    {activeCategory === 'favourites' ? 'No favourites yet. Tap the heart to add!' : 'No locations found'}\r\n                                </p>\r\n                            </div>\r\n                        ) : (\r\n                            filteredLocations.map((location, idx) => (\r\n                                <div\r\n                                    key={location.id}\r\n                                    onClick={() => handleSelectLocation(location)}\r\n                                    role=\"button\"\r\n                                    tabIndex={0}\r\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSelectLocation(location)}\r\n                                    className={`w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-800/50 transition-colors cursor-pointer ${idx < filteredLocations.length - 1 ? 'border-b border-gray-800' : ''}`}\r\n                                >\r\n                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center shrink-0 ${getCategoryColor(location.category)}`}>\r\n                                        <span className=\"material-symbols-outlined text-xl\">{getCategoryIcon(location.category)}</span>\r\n                                    </div>\r\n                                    <div className=\"flex flex-col items-start flex-1 text-left truncate\">\r\n                                        <p className=\"text-white text-base font-medium leading-normal truncate w-full\">\r\n                                            {location.name}\r\n                                        </p>\r\n                                        <p className=\"text-[#617589] dark:text-gray-400 text-xs truncate w-full\">\r\n                                            Near {location.nearestStop || 'UTM'}\r\n                                        </p>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={(e) => toggleFavourite(e, location)}\r\n                                        className=\"p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n                                    >\r\n                                        <span className={`material-symbols-outlined text-xl ${isFavourite(location.id) ? 'text-red-500 fill-red-500' : 'text-gray-300 dark:text-gray-600'}`}\r\n                                            style={{ fontVariationSettings: isFavourite(location.id) ? \"'FILL' 1\" : \"'FILL' 0\" }}\r\n                                        >\r\n                                            favorite\r\n                                        </span>\r\n                                    </button>\r\n                                </div>\r\n                            ))\r\n                        )}\r\n                    </div>\r\n                )}\r\n            </main>\r\n\r\n            {/* Bottom Navigation */}\r\n            <BottomNavigation activeTab={activeTab} onTabChange={onTabChange} />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MobileSearchPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\services\\api.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\utils\\routeGeometryUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\src\\utils\\scheduleUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tabe2\\OneDrive\\Desktop\\UTM move\\Frontend\\vite.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
