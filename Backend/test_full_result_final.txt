
> backend@1.0.0 test
> jest --verbose tests/

  console.log
    DEBUG: Running A* search from 0,0 to undefined

      at Object.log [as getDirections] (directions/index.js:118:13)

  console.log
    DEBUG: Running A* search from 0,0 to undefined

      at Object.log [as getDirections] (directions/index.js:118:13)

  console.log
    DEBUG: Running A* search from 0,0 to undefined

      at Object.log [as getDirections] (directions/index.js:118:13)

PASS tests/directionsIntegration.test.js
  getDirections Integration
    âˆš returns direct bus route from A* result (19 ms)
    âˆš falls back to transfer route from A* result (2 ms)
    âˆš returns walk only if A* returns no bus legs (1 ms)

  console.log
    [DataLoader] Loaded: 55 stops, 732 locations, 49 stop-routes indexed

      at log (directions/dataLoader.js:145:13)

  console.log
    [ReproTest Debug] CP Routes Count before call: 11

      at Object.log (tests/repro_G17_FKT.test.js:42:17)

  console.warn
    GraphHopper Matrix fetch failed, using Haversine: HTTP 404 Not Found

    [0m [90m 120 |[39m         }
     [90m 121 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 122 |[39m         console[33m.[39mwarn([32m'GraphHopper Matrix fetch failed, using Haversine:'[39m[33m,[39m error[33m.[39mresponse[33m?[39m[33m.[39mdata[33m?[39m[33m.[39mmessage [33m||[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 123 |[39m     }
     [90m 124 |[39m
     [90m 125 |[39m     [36mreturn[39m [36mnull[39m[33m;[39m[0m

      at warn (directions/locationService.js:122:17)
      at findNearestStops (directions/locationService.js:156:25)
      at Object.getDirections (directions/index.js:76:28)
      at Object.<anonymous> (tests/repro_G17_FKT.test.js:44:24)

  console.log
    DEBUG: Running A* search from 1.558355,103.630752 to Fakulti Kejuruteraan Tenaga/Kimia

      at Object.log [as getDirections] (directions/index.js:118:13)

  console.log
    Result Type: DIRECT

      at Object.log (tests/repro_G17_FKT.test.js:55:21)

  console.log
    Full Result: {
      "type": "DIRECT",
      "origin": {
        "name": "Centre Point",
        "lat": 1.558355,
        "lon": 103.630752
      },
      "destination": {
        "id": "FKT",
        "name": "Fakulti Kejuruteraan Tenaga/Kimia",
        "lat": 1.56652,
        "lon": 103.640282,
        "nearestStop": "FKT",
        "category": "bus_stop"
      },
      "summary": {
        "route": "Route D",
        "headsign": "To FKT(n29)",
        "departure": "08:15",
        "minutesUntil": 7.056335079229484,
        "departureDay": "monday",
        "busArrivalTime": "08:21",
        "totalDuration": 21,
        "eta": "08:21"
      },
      "steps": [
        {
          "type": "walk",
          "instruction": "Walk to Centre Point",
          "from": {
            "lat": 1.558355,
            "lon": 103.630752
          },
          "to": {
            "lat": 1.559728,
            "lon": 103.634814
          },
          "distance": 477,
          "duration": 0,
          "details": [],
          "expanded": false
        },
        {
          "type": "board",
          "instruction": "Board Route D (To FKT(n29))",
          "stopName": "Centre Point",
          "stopId": "CP",
          "time": "08:15",
          "upcomingTimes": [
            "08:15",
            "08:45",
            "09:15"
          ],
          "routeGeometryKey": "Route D : To FKT(n29)"
        },
        {
          "type": "ride",
          "instruction": "Ride NaN stops to Fakulti Kejuruteraan Tenaga/Kimia",
          "duration": 6
        },
        {
          "type": "alight",
          "instruction": "Alight at Fakulti Kejuruteraan Tenaga/Kimia",
          "stopName": "Fakulti Kejuruteraan Tenaga/Kimia",
          "stopId": "FKT",
          "time": "08:21"
        },
        {
          "type": "walk",
          "instruction": "Walk to Fakulti Kejuruteraan Tenaga/Kimia",
          "from": {
            "lat": 1.56652,
            "lon": 103.640282
          },
          "to": {
            "id": "FKT",
            "name": "Fakulti Kejuruteraan Tenaga/Kimia",
            "lat": 1.56652,
            "lon": 103.640282,
            "nearestStop": "FKT",
            "category": "bus_stop"
          },
          "distance": 0,
          "duration": 0,
          "details": [],
          "expanded": false
        }
      ],
      "totalWalkingDistance": 477,
      "directWalkDistance": 1395,
      "routeGeometry": {
        "coordinates": [
          [
            103.634847,
            1.55973
          ],
          [
            103.634827,
            1.559995
          ],
          [
            103.634861,
            1.559984
          ],
          [
            103.634882,
            1.560418
          ],
          [
            103.634884,
            1.560477
          ],
          [
            103.63499,
            1.56078
          ],
          [
            103.635107,
            1.561048
          ],
          [
            103.635226,
            1.561308
          ],
          [
            103.635292,
            1.561422
          ],
          [
            103.635695,
            1.562013
          ],
          [
            103.636141,
            1.562472
          ],
          [
            103.63624,
            1.562553
          ],
          [
            103.636312,
            1.562589
          ],
          [
            103.636432,
            1.562651
          ],
          [
            103.636503,
            1.562687
          ],
          [
            103.636547,
            1.56271
          ],
          [
            103.636995,
            1.562917
          ],
          [
            103.637202,
            1.562952
          ],
          [
            103.637323,
            1.562966
          ],
          [
            103.637312,
            1.562938
          ],
          [
            103.637453,
            1.56295
          ],
          [
            103.637678,
            1.562957
          ],
          [
            103.637899,
            1.562945
          ],
          [
            103.638031,
            1.56292
          ],
          [
            103.638168,
            1.562894
          ],
          [
            103.638314,
            1.562859
          ],
          [
            103.638584,
            1.562792
          ],
          [
            103.638631,
            1.562779
          ],
          [
            103.638627,
            1.562824
          ],
          [
            103.638996,
            1.562734
          ],
          [
            103.63914,
            1.562688
          ],
          [
            103.639716,
            1.562502
          ],
          [
            103.639888,
            1.562448
          ],
          [
            103.640641,
            1.562068
          ],
          [
            103.640666,
            1.562089
          ],
          [
            103.640773,
            1.562202
          ],
          [
            103.640823,
            1.562269
          ],
          [
            103.640838,
            1.562317
          ],
          [
            103.640844,
            1.562519
          ],
          [
            103.640767,
            1.562673
          ],
          [
            103.640682,
            1.562756
          ],
          [
            103.640518,
            1.562892
          ],
          [
            103.64039,
            1.562987
          ],
          [
            103.640279,
            1.563073
          ],
          [
            103.640162,
            1.563201
          ],
          [
            103.640093,
            1.563322
          ],
          [
            103.640009,
            1.563464
          ],
          [
            103.639894,
            1.563547
          ],
          [
            103.63976,
            1.563593
          ],
          [
            103.639618,
            1.563652
          ],
          [
            103.639521,
            1.56373
          ],
          [
            103.639393,
            1.563787
          ],
          [
            103.639206,
            1.563909
          ],
          [
            103.638774,
            1.564202
          ],
          [
            103.638523,
            1.564413
          ],
          [
            103.638452,
            1.564539
          ],
          [
            103.638425,
            1.564595
          ],
          [
            103.638314,
            1.564848
          ],
          [
            103.638269,
            1.565065
          ],
          [
            103.638244,
            1.565191
          ],
          [
            103.638228,
            1.565287
          ],
          [
            103.638227,
            1.565559
          ],
          [
            103.638232,
            1.565644
          ],
          [
            103.63826,
            1.566073
          ],
          [
            103.638278,
            1.566218
          ],
          [
            103.638341,
            1.566324
          ],
          [
            103.63845,
            1.566387
          ],
          [
            103.638722,
            1.566487
          ],
          [
            103.639577,
            1.566862
          ],
          [
            103.639626,
            1.566883
          ],
          [
            103.639748,
            1.566922
          ],
          [
            103.639879,
            1.566904
          ],
          [
            103.640002,
            1.566886
          ],
          [
            103.640078,
            1.566854
          ],
          [
            103.640212,
            1.566686
          ],
          [
            103.640256,
            1.566582
          ],
          [
            103.640289,
            1.566524
          ]
        ],
        "type": "LineString"
      },
      "routeGeometries": null,
      "isLoopRoute": false,
      "loopInfo": null,
      "originStop": {
        "id": "CP",
        "name": "Centre Point",
        "lat": 1.559728,
        "lon": 103.634814
      },
      "destStop": {
        "id": "FKT",
        "name": "Fakulti Kejuruteraan Tenaga/Kimia",
        "lat": 1.56652,
        "lon": 103.640282
      }
    }

      at Object.log (tests/repro_G17_FKT.test.js:56:21)

  console.log
    Boarding At: Centre Point

      at Object.log (tests/repro_G17_FKT.test.js:61:25)

  console.log
    Alighting At: Fakulti Kejuruteraan Tenaga/Kimia

      at Object.log (tests/repro_G17_FKT.test.js:64:25)

PASS tests/repro_G17_FKT.test.js
  G17 to FKT Debug
    âˆš should prefer Walk->CP->Bus D over Bus E->JA1->Walk (89 ms)

  console.log
    [DataLoader] Loaded: 55 stops, 732 locations, 49 stop-routes indexed

      at log (directions/dataLoader.js:145:13)

  console.log
    DEBUG findLoopRoutes: CP -> CP

      at log (directions/routeFinder.js:119:13)

  console.log
      Route Route A: originTrip To Centre Point (CP)

      at log (directions/routeFinder.js:126:17)

  console.log
        MATCH To KP: destIdx 0

      at log (directions/routeFinder.js:158:21)

  console.log
      Route Route C: originTrip To Centre Point (CP)

      at log (directions/routeFinder.js:126:17)

  console.log
        MATCH To Kolej 9/10: destIdx 0

      at log (directions/routeFinder.js:158:21)

  console.log
      Route Route D: originTrip To FKT(n29)

      at log (directions/routeFinder.js:126:17)

  console.log
        MATCH To CP: destIdx 3

      at log (directions/routeFinder.js:158:21)

  console.log
      Route Route E(JA): originTrip To Cluster (T02)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To KDOJ: dest CP not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
      Route Route E(N24): originTrip To Cluster (T02)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To KDOJ: dest CP not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
        Skip To K9/10: no common day

      at log (directions/routeFinder.js:138:25)

  console.log
        Skip To KDOJ (From K9/10): no common day

      at log (directions/routeFinder.js:138:25)

  console.log
      Route Route F: originTrip To KTR(K01)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To P19A: dest CP not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
      Route Route G: originTrip To KTR(K01)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To FKT(N29): dest CP not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
    DEBUG findLoopRoutes: CP -> KDOJ

      at log (directions/routeFinder.js:119:13)

  console.log
      Route Route A: originTrip To Centre Point (CP)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To KP: dest KDOJ not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
      Route Route C: originTrip To Centre Point (CP)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To Kolej 9/10: dest KDOJ not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
      Route Route D: originTrip To FKT(n29)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To CP: dest KDOJ not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
      Route Route E(JA): originTrip To Cluster (T02)

      at log (directions/routeFinder.js:126:17)

  console.log
        MATCH To KDOJ: destIdx 13

      at log (directions/routeFinder.js:158:21)

  console.log
      Route Route E(N24): originTrip To Cluster (T02)

      at log (directions/routeFinder.js:126:17)

  console.log
        MATCH To KDOJ: destIdx 13

      at log (directions/routeFinder.js:158:21)

  console.log
        Skip To K9/10: no common day

      at log (directions/routeFinder.js:138:25)

  console.log
        Skip To KDOJ (From K9/10): no common day

      at log (directions/routeFinder.js:138:25)

  console.log
      Route Route F: originTrip To KTR(K01)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To P19A: dest KDOJ not on trip

      at log (directions/routeFinder.js:152:25)

  console.log
      Route Route G: originTrip To KTR(K01)

      at log (directions/routeFinder.js:126:17)

  console.log
        Skip To FKT(N29): dest KDOJ not on trip

      at log (directions/routeFinder.js:152:25)

PASS tests/directionLogic.test.js
  getStopById
    âˆš returns stop object for valid ID (4 ms)
    âˆš returns undefined for invalid ID (1 ms)
    âˆš returns undefined for null/empty input
  getLocationById
    âˆš finds location by exact ID from bus stops
    âˆš finds bus stop as location fallback
    âˆš returns null for invalid location
    âˆš supports case-insensitive matching
  getRoutesForStop
    âˆš returns routes for major hub (CP) (2 ms)
    âˆš returns empty array for non-existent stop
  findDirectRoutes
    âˆš finds route from origin to destination on same line
    âˆš ensures origin comes before destination in sequence
    âˆš returns empty for invalid stops (1 ms)
    âˆš handles same origin and destination (may return loop routes) (11 ms)
  findTransferRoutes
    âˆš finds transfer route via CP (9 ms)
    âˆš returns null when no transfer route possible
  haversineDistance (re-exported)
    âˆš is accessible from directionLogic exports (1 ms)
    âˆš calculates reasonable distance

  console.log
    DEBUG findRoutesToNearbyStops: {
      originStopId: 'Stop1',
      destLocation: { lat: 10, lon: 10 },
      maxWalkingDistanceM: 500,
      stopsById: 'Map with 3 entries',
      originRoutesCount: 1
    }

      at log (directions/routeFinder.js:62:13)

  console.log
      Route: RouteA (To Dest), originIdx: 0, stops: 4

      at log (directions/routeFinder.js:73:17)

  console.log
        MATCH: Stop2 (undefined), walkDist: 200m

      at log (directions/routeFinder.js:92:25)

  console.log
        MATCH: Stop4 (undefined), walkDist: 300m

      at log (directions/routeFinder.js:92:25)

  console.log
    DEBUG findRoutesToNearbyStops: {
      originStopId: 'Stop1',
      destLocation: { lat: 10, lon: 10 },
      maxWalkingDistanceM: 500,
      stopsById: 'Map with 1 entries',
      originRoutesCount: 1
    }

      at log (directions/routeFinder.js:62:13)

  console.log
      Route: RouteA (To Dest), originIdx: 0, stops: 4

      at log (directions/routeFinder.js:73:17)

  console.log
        Stop Stop3 not found in stopsById

      at log (directions/routeFinder.js:80:25)

  console.log
        Stop Stop4 not found in stopsById

      at log (directions/routeFinder.js:80:25)

  console.log
    DEBUG findTransferCandidates: Origin via transfer points

      at log (directions/routeFinder.js:222:13)

  console.log
    DEBUG findRoutesToNearbyStops: {
      originStopId: 'CP',
      destLocation: { lat: 10, lon: 10 },
      maxWalkingDistanceM: 500,
      stopsById: 'Map with 1 entries',
      originRoutesCount: 1
    }

      at log (directions/routeFinder.js:62:13)

  console.log
      Route: Route2 (To Dest), originIdx: 0, stops: 3

      at log (directions/routeFinder.js:73:17)

  console.log
        Stop StopA not found in stopsById

      at log (directions/routeFinder.js:80:25)

  console.log
        MATCH: StopB (undefined), walkDist: 100m

      at log (directions/routeFinder.js:92:25)

  console.log
    DEBUG findLoopRoutes: Origin -> KTC

      at log (directions/routeFinder.js:119:13)

  console.log
    DEBUG findLoopRoutes: Origin -> AM

      at log (directions/routeFinder.js:119:13)

  console.log
    DEBUG findLoopRoutes: Origin -> KRP

      at log (directions/routeFinder.js:119:13)

  console.log
    DEBUG findTransferCandidates found 1 options

      at log (directions/routeFinder.js:256:13)

PASS tests/routeFinder.test.js
  routeFinder
    findRoutesToNearbyStops
      âˆš finds downstream stops within walking distance (4 ms)
      âˆš returns empty if no stops within range (2 ms)
    findTransferCandidates
      âˆš finds valid transfer via CP to nearby stop (4 ms)

PASS tests/enrich_schedule_logic.test.js
  enrichSchedule
    âˆš returns enriched schedule data with same structure (1 ms)
    âˆš adds arrival_offsets to trips
    âˆš arrival_offsets has correct length (one per stop) (1 ms)
    âˆš first stop always has offset 0
    âˆš offsets are non-decreasing
    âˆš adds calculated_duration to trips
    âˆš handles missing geometry gracefully
    âˆš preserves original stops data
    âˆš preserves trip times (1 ms)

  console.log
    [DataLoader] Loaded: 55 stops, 732 locations, 49 stop-routes indexed

      at log (directions/dataLoader.js:145:13)

  console.log
    [Jest Debug] CP Routes Count: 11

      at Object.log (tests/debug_loader.test.js:7:17)

  console.log
    [Jest Debug] - Route A (To Centre Point (CP)) Index: 3

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route A (To KP) Index: 0

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route C (To Centre Point (CP)) Index: 6

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route C (To Kolej 9/10) Index: 0

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route D (To FKT(n29)) Index: 0

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route D (To CP) Index: 3

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route E(JA) (To Cluster (T02)) Index: 8

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route E(N24) (To Cluster (T02)) Index: 8

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route E(N24) (To K9/10) Index: 8

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route F (To KTR(K01)) Index: 1

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

  console.log
    [Jest Debug] - Route G (To KTR(K01)) Index: 3

      at log (tests/debug_loader.test.js:10:25)
          at Array.forEach (<anonymous>)

PASS tests/debug_loader.test.js
  Debug Loader
    âˆš should load all routes for CP (10 ms)

PASS tests/geo.test.js
  haversineDistance
    âˆš returns 0 for same coordinates
    âˆš calculates correct distance between two known points
    âˆš is symmetric (A to B equals B to A)
    âˆš handles negative coordinates
  getPathDistance
    âˆš returns 0 for single point path
    âˆš returns 0 for empty path
    âˆš calculates correct total distance for multi-point path
    âˆš path distance is >= direct distance (triangle inequality)

PASS tests/routeScorer.test.js
  routeScorer
    evaluateCandidates
      âˆš selects route with lowest total score (1 ms)
      âˆš handles next day departure
    isWalkingBetter
      âˆš prefers walking for very short distances

PASS tests/constants.test.js
  ROUTE_COLORS
    âˆš has colors for all main routes A-G and L (1 ms)
    âˆš all colors are valid hex codes
    âˆš each route has a unique color (1 ms)
  getRouteColor
    âˆš returns correct color for "Route A"
    âˆš returns correct color for "Route E(JA)"
    âˆš handles just the letter
    âˆš handles lowercase input
    âˆš returns fallback gray for null/undefined
    âˆš returns fallback for unknown route letter

PASS tests/astar.test.js
  A*
    âˆš finds path Walk -> Bus -> Walk (1 ms)
    âˆš returns null if no path found

Test Suites: 10 passed, 10 total
Tests:       56 passed, 56 total
Snapshots:   0 total
Time:        0.686 s, estimated 1 s
Ran all test suites matching tests/.
